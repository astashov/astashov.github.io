
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Anton Astashov's blog</title>
  <meta name="author" content="Anton Astashov">

  
  <meta name="description" content="There was a link to flutter.io recently, which went to Hacker News, Reddit, etc. The project itself is on the very early stage, not even alpha, afaik &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://astashov.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Anton Astashov's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20358438-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Anton Astashov's blog</a></h1>
  
    <h2>Would be nice to write something clever here.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
  
  
  
  
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:astashov.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/18/when-dart-is-a-good-choice/">When Dart Is a Good Choice</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-18T09:55:58-06:00" pubdate data-updated="true">Nov 18<sup>th</sup>, 2015</time>
        
           | <a href="/blog/2015/11/18/when-dart-is-a-good-choice/#disqus_thread"
             data-disqus-identifier="http://astashov.github.io/blog/2015/11/18/when-dart-is-a-good-choice/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There was a link to <a href="https://flutter.io">flutter.io</a> recently, which went to Hacker News, Reddit, etc. The project itself is on the very early stage, not even alpha, afaik, and it wasn&rsquo;t an announcement, somebody just posted a link to flutter.io there.</p>

<p>The programming language they use for Flutter is Dart. And I was really surprised by the crowd responses related to Dart &ndash; there was so much hate. It seems like there is some confusion among people about what the language and its ecosystem is these days. Since I have some experience with it, I decided to share my thoughts on the language and its ecosystem, what it&rsquo;s good for and what it&rsquo;s maybe not the best choice for, again, from my experience.</p>

<p>So, from my perspective, the main selling points, things which are really nicely done in Dart, are:</p>

<h2>Async</h2>

<p>As I <a href="http://astashov.github.io/blog/2015/11/08/dart-tricks-in-dartdocs-org/">previously mentioned</a>, Dart has really nice async support across its whole ecosystem. Futures and Streams were added to the SDK from the very early versions, so they became standard de-facto, and are used in all the places where asynchronoucity is expected.</p>

<p>I didn&rsquo;t see any alternative implementations of Futures or Streams in the wild, everybody just uses the SDK&rsquo;s ones. And majority of packages is built with async APIs, methods return Futures and/or Streams. This makes them nicely composable with each other.</p>

<p>If you&rsquo;re building a front-end app, you&rsquo;ll have all the DOM events wrapped into Streams in SDK. If you&rsquo;re building a web-service, database drivers (e.g. <a href="https://pub.dartlang.org/packages/sqljocky">MySql</a>) return the Stream with results as a result of query execution. <a href="https://pub.dartlang.org/packages/logging">Loggers</a> give you a Stream with all the log records. You can subscribe/unsubscribe to these streams, map/filter/fold them, etc. All that stuff provides a good foundation for building <a href="https://en.wikipedia.org/wiki/Functional_reactive_programming">FRP</a> apps in Dart.</p>

<p>Working with Futures also became pretty pleasant since Dart got async/await support. That allows you to write heavily async/concurrent applications, which look very synchronous. Futures, again, are everywhere &ndash; <a href="https://pub.dartlang.org/packages/http">HTTP</a> has Future-based API, <a href="https://pub.dartlang.org/packages/test">unit tests</a> cases will wait if the test returns a Future, <a href="https://pub.dartlang.org/packages/redstone">web frameworks</a> will also handle it properly if the request handler returns a Future, etc.</p>

<p>There are <a href="https://www.dartlang.org/articles/zones/">Zones</a>, which nicely augment the async story of Dart. They give you the ability to wrap any piece of code into a &ldquo;Zone&rdquo;, which will keep the async context of that piece of code. So you can catch all the errors (even if they happened in the async part of it), store zone-local values (they will be accessible globally inside the zone), and do a bunch of other things.</p>

<p>Generally, debugging of async apps is painful, because stack traces are messed up, and it&rsquo;s hard to figure out where we came from to the point where the exception happened. They may look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unhandled exception:
</span><span class='line'>Uncaught Error: foo
</span><span class='line'>Stack Trace:
</span><span class='line'>#0      blah.&lt;blah_async_body&gt; (file:///Users/anton/projects/blah/blah.dart:7:3)
</span><span class='line'>#1      Future.Future.microtask.&lt;anonymous closure&gt; (dart:async/future.dart:144)
</span><span class='line'>#2      _microtaskLoop (dart:async/schedule_microtask.dart:43)
</span><span class='line'>#3      _microtaskLoopEntry (dart:async/schedule_microtask.dart:52)
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Which gives you very little information, just the actual line where the exception happened. You have no clue how the app got to that point. Luckily, there is <a href="https://pub.dartlang.org/packages/stack_trace">stack_trace</a> package, which has <code>Chain.capture()</code> method. It uses Zones under the hood, and if you wrap your code with it, the stack traces became way nicer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>blah.dart 7:3        blah.&lt;async&gt;
</span><span class='line'>===== asynchronous gap ===========================
</span><span class='line'>dart:async           _Completer.completeError
</span><span class='line'>blah.dart 10:1       blah.&lt;async&gt;
</span><span class='line'>===== asynchronous gap ===========================
</span><span class='line'>dart:async           Future.Future.microtask
</span><span class='line'>blah.dart            blah
</span><span class='line'>blah.dart 14:15      main.&lt;fn&gt;.&lt;async&gt;.&lt;fn&gt;.&lt;async&gt;.&lt;fn&gt;.&lt;async&gt;
</span><span class='line'>===== asynchronous gap ===========================
</span><span class='line'>dart:async           Future.Future
</span><span class='line'>blah.dart 13:17      main.&lt;fn&gt;.&lt;async&gt;.&lt;fn&gt;.&lt;async&gt;
</span><span class='line'>===== asynchronous gap ===========================
</span><span class='line'>dart:async           Future.Future
</span><span class='line'>blah.dart 12:28      main.&lt;fn&gt;.&lt;async&gt;
</span><span class='line'>===== asynchronous gap ===========================
</span><span class='line'>dart:async           Future.Future.microtask
</span><span class='line'>blah.dart            main.&lt;fn&gt;
</span><span class='line'>package:stack_trace  Chain.capture
</span><span class='line'>blah.dart 11:9       main</span></code></pre></td></tr></table></div></figure>


<p>It adds some performance and memory penalty, but usually it&rsquo;s neglectable, and it helps a lot with debugging.</p>

<p>So, IMHO, Dart is really good for building front-end apps or single-threaded back-end services. Unfortunately, multithreading support is pretty immature for now &ndash; there are actor-based <a href="https://www.dartlang.org/docs/dart-up-and-running/ch02.html#isolates">isolates</a>, but they are very slow (instantiating of an isolate takes almost a second (sic!), and the throughput is about 20000-30000 messages per second on my MacBook Pro).</p>

<h2>Staticly typed</h2>

<p>It&rsquo;s nice that there&rsquo;s no compile-time, with there is static analysis support. Despite the fact the type system is &ldquo;optional and unsound&rdquo;, not using type annotations for public methods and functions is considered a bad practice.</p>

<p>The fact the language has source based VM actually simplifies debugging a lot. Despite a decent debugger and other tools, the most convenient way of debugging programs for me is still just throwing print statements. Here, you can easily throw them into the source code of any package or into SDK itself, and immediately see them on page refresh or script restart.</p>

<p>Static analyzer is written as a <a href="https://pub.dartlang.org/packages/analyzer">package</a>, and also there is a daemon (basically headless IDE), which uses it and provides API, which could by used by the IDEs to provide Dart support. The analyzer supports autocomplete, go to definition, find usages, refactoring, etc. This is really cool, because it simplifies writing tools, which require analyzing of the source code. Like:</p>

<ul>
<li>Auto Code formatter (dartfmt)</li>
<li>Command line <a href="https://pub.dartlang.org/packages/tuneup">static analyzer</a></li>
<li><a href="https://pub.dartlang.org/packages/linter">Linter</a></li>
<li><a href="https://www.crossdart.info">Crossdart</a></li>
<li><a href="https://chrome.google.com/webstore/detail/crossdart-chrome-extensio/jmdjoliiaibifkklhipgmnciiealomhd">Crossdart Github Plugin</a></li>
<li><a href="https://dart-lang.github.io/observatory/">Observatory</a> (the tool for debugging, profiling and monitoring running Dart processes)</li>
</ul>


<p>Static analyzis allows to find a lot of errors, which would be found in runtime otherwise later by end users. The analyzis coverage is okay, but sometimes I&rsquo;d like it to be stricter. There is a new <a href="https://github.com/dart-lang/dev_compiler/blob/master/STRONG_MODE.md">&ldquo;strong mode&rdquo;</a> option in the analyzer coming, which will be stricter, especially related to &ldquo;dynamic&rdquo; variables (where the type inference failed, or where it was specifically marked as dynamic), and I&rsquo;m really looking forward to it.</p>

<p>There is one thing missing, though, and it really hurts. Unfortunately, there&rsquo;s currently no method generics (just class generics). There is <a href="https://github.com/leafpetersen/dep-generic-methods/blob/master/proposal.md">DEP</a> for that though, and it seems like the Dart team is experimenting with them in the new JS transpiler (implemented as annotations for now though), which gives me some hope it will wind up to the VM later as well.</p>

<h2>Tooling</h2>

<p>Humans are weak. We have hard time keeping more than 7 things in our head simultaneously, we forget things to do, we make mistakes, and cannot fully keep big complex constructs in our head. Complexity of large applications easily go waaay over what average human&rsquo;s brains can process and keep track of.</p>

<p>So, we rely on tools instead. The programming language should be expressive and allow to build powerful abstractions, which would help us to handle the complexity. But that&rsquo;s not enough. We also need a code editor, which would help us to navigate through the thousands of lines of code, we need static analyzers, which will catch the errors we made early, we need linters or code formatters, which will make sure we write in the same style within the team, because keeping the code in the same styles reduces its complexity, etc.</p>

<p>Luckily, Dart&rsquo;s tooling story is very good.</p>

<p>There are 2 main IDEs &ndash; <a href="https://plugins.jetbrains.com/plugin/6351">Intellij IDEA</a> and <a href="https://atom.io/packages/dartlang">Github&rsquo;s Atom</a>. They are being developed simultaneously. I prefer IDEA for now, it works flawlessly, everything I need from IDE is there &ndash; go to definition, find usages, refactoring (I mostly use just renaming though), auto adding imports, integration with dartfmt, debugger, reliable search through class/method names, etc. The only missing thing for me &ndash; it doesn&rsquo;t show a propagated type (if you rely on type inference). This feature is presented in Atom, but it&rsquo;s missing other stuff, like debugger and search for class/method names. It seems like Atom is developing faster though, so we&rsquo;ll see how fast it will get the debugger and the search.</p>

<p>There is dartfmt, which autoformats the code for you. It may not match your style preference, but I found it&rsquo;s just easier to give up and let it style my code for me. A lot of tools also use dartfmt under the hood (e.g. code generator tool <a href="https://pub.dartlang.org/packages/source_gen">source_gen</a>), so it kind of makes sense to use it, so your code and autogenerated code look similar.</p>

<p>There is <a href="https://dart-lang.github.io/observatory/">Observatory</a>, which allows to connect to running Dart processes and debug and profile them, and monitor the metrics.</p>

<p>There is my <a href="https://chrome.google.com/webstore/detail/crossdart-chrome-extensio/jmdjoliiaibifkklhipgmnciiealomhd">Crossdart Chrome plugin for Github</a>, which adds &lsquo;go to definition&rsquo; and &lsquo;find usages&rsquo; functionality to Github&rsquo;s tree views and pull requests, which is reaaally useful for code reviews.</p>

<p>There is <a href="https://pub.dartlang.org/">pub</a>, Dart&rsquo;s package manager. It has pretty simple CLI API, but allows to do all the necessary things for managing dependencies. Seems to be heavily influenced by Ruby&rsquo;s Bundler. One of the neat features &ndash; allows to override dependencies with local ones or just force some version (ignoring requirements of other packages). It&rsquo;s very useful when your app is very modular, and depends on many internal packages.</p>

<p>There is <a href="https://www.dartdocs.org">Dartdocs</a>, the documentation for all the packages on pub.</p>

<p>And there is <a href="https://crossdart.info">Crossdart</a>, the hyperlinked source code for all the packages on pub.</p>

<p>And a lot more.</p>

<h2>Decent language</h2>

<p>Though Dart is a bit conservative language (for my taste), it&rsquo;s a quite decent OOP language. I like how the language encourages explicitness, provides a solid and well-structured SDK, and offers pretty logical and straightforward semantics. There are also some nice new features, like implicit interfaces (basically you can use any class as an interface), factory constructors, method cascades, etc.</p>

<p>There are also things that I&rsquo;d expect from a modern language and are missing at the moment, like:</p>

<ul>
<li>Method generics (you can only specify generics on a class)</li>
<li>Non-nullable types (like in Swift or Kotlin, <code>String</code> and <code>String?</code>)</li>
<li>Value objects and better immutability story overall. To be fair, it&rsquo;s kind of possible right now, if you just create classes where all the fields are final and use something like <a href="https://pub.dartlang.org/packages/vacuum_persistent">vacuum_persistent</a> for immutable maps/sets/vectors, but you potentially can still add mutable objects into your immutable hierarchy. You also have to implement equality, copy method, etc, every time. There are a bunch of packages, which solve that with the code generation (like <a href="https://pub.dartlang.org/packages/value_object">this one</a>), but it still looks like a workaround. I miss Scala&rsquo;s case classes and Kotlin&rsquo;s data classes :)</li>
</ul>


<p>I should mention though that there are DEPs for <a href="https://github.com/leafpetersen/dep-generic-methods/blob/master/proposal.md">Method Generics</a> and for <a href="https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md">Non-Nullable Types</a>, so there is a hope they will be added eventually.</p>

<h2>Summary</h2>

<p>From my experience, it was a breeze to use Dart for:</p>

<ul>
<li>Developing large complex web applications working in browser. For example, <a href="https://www.montagebook.com">Montage</a>. Static typing, tools and analyzer made it way easier to create and then maintain that photo book editor.</li>
<li>Developing single-threaded services with async IO, which use MySQL, PostgreSQL, Mongo or RethinkDB. If your service is just fetching some data from a database and network, then aggregating it somehow and returning in JSON or HTML (which seems to be a majority of use cases), you can get pretty good performance even on one thread, since all your IO will be async and non-blocking from the top to the bottom, and at the same time won&rsquo;t look like a callback hell.</li>
</ul>


<p>What it&rsquo;s potentially not good for:</p>

<ul>
<li>Multi-threaded services &ndash; isolates are not there yet.</li>
<li>Something which needs MSSQL &ndash; seems like no driver for it</li>
<li>Obviously, if you&rsquo;re tied to another platform, you may want to use something else (like, JVM)</li>
<li>There are not many packages on pub (just about 2000), so check first if you have everything you need there.</li>
</ul>


<p>Choosing a language and a platform is always a tradeoff. There are some things I don&rsquo;t really like in Dart, but given the decent staticly typed language with good semantics, which feels like interpreted language (because the VM runs the source code, not the bytecode), great tooling, and great async support &ndash; there are not many alternatives at the end.</p>

<p>So, check Dart out if you haven&rsquo;t yet, maybe you&rsquo;ll find it useful too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/08/dart-tricks-in-dartdocs-org/">Dart Tricks in dartdocs.org</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-08T21:01:01-06:00" pubdate data-updated="true">Nov 8<sup>th</sup>, 2015</time>
        
           | <a href="/blog/2015/11/08/dart-tricks-in-dartdocs-org/#disqus_thread"
             data-disqus-identifier="http://astashov.github.io/blog/2015/11/08/dart-tricks-in-dartdocs-org/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve just finished building new infrastructure for <a href="https://www.dartdocs.org">Dartdocs</a>, and <a href="https://plus.google.com/+SethLadd">Seth</a> asked me to share my experience with Dart there. Obviously, you expect infrastructure for generating Dart docs for all the packages on <a href="https://pub.dartlang.org/">pub</a> to be written in Dart, though it might be built in any programming language. All it needs in a nutshell is to run a dartdoc shell command, which actually generates the documentation, and then upload the generated files somewhere.</p>

<p>This is not my first Dart project, we use Dart in <a href="http://www.mixbook.com">Mixbook</a> (where I work) pretty heavily, mostly for <a href="https://www.montagebook.com">various</a> <a href="http://www.mixbook.com/canvas-prints">client-side</a> <a href="http://www.mixbook.com/photo-prints">projects</a>, but we also have some microservices on backend written in Dart as well. I love Dart, but like with any technology, using it is a tradeoff. It has its own pros (great async support, amazing tooling and ecosystem, staticly typed, but interpreted &ndash; no compile time) and cons (type system is not strict enough, IMHO, also a bit conservative for a modern language, i.e. where are my non-nullable types, method generics and immutable value objects?! :)), but for me pros outweight cons, so I use it a lot, and actually pretty happy with it.</p>

<p>The requirements for <a href="http://www.dartdocs.org">http://www.dartdocs.org</a> were pretty simple &ndash; the infrastructure for generating docs for the Dart pub ecosystem, which is:</p>

<ul>
<li>Efficient &ndash; should use the available computing resources efficiently, avoid unnecessary work</li>
<li>Scalable &ndash; allows to regenerate the documentation for the whole Dart ecosystem quickly (which is thousands and thousands Dart packages), within several hours, in case there is a new version of <a href="https://github.com/dart-lang/dartdoc">dartdoc</a> tool.</li>
<li>Reliable &ndash; should work unattended, restore itself in case of failures, and should be easy to debug in case of failures.</li>
</ul>


<p>These requirements describe pretty much any web service you usually write :) So, I&rsquo;ll describe several tricks below I used in dartdocs to achieve these.</p>

<h2>Efficiency</h2>

<p>As I already said, Dart has really nice async support, for me this is one of its killer features. Futures and Streams were added to SDK from the very early versions, which means all the packages just use the SDK&rsquo;s ones, and nobody tries to reinvent their own implementations of Futures or Streams. And this is a big deal! A lot of packages are built with concurrency support as well, methods return Futures and Streams, and that makes these packages composable with each other, since every package uses the same implementation of Futures and Streams. Web frameworks, database drivers, unit test packages, file system tools, loggers, http libraries, socket handling, etc &ndash; all of them usually support concurrency and non-blocking operations. This allows us to build event-based fully concurrent web services pretty easily (especially after adding async/await support in Dart 1.9!)</p>

<p>So, a workflow for the main dartdocs.org script is:</p>

<ul>
<li>Download all the existing package names and versions from pub (or refresh the list if already downloaded)</li>
<li>Download (or refresh) the metadata for already generated packages from Google Cloud Datastore (was it successfully generated or not, generation datetime, etc)</li>
<li>Figure out the next batch of packages to generate</li>
<li>Actually generate the docs</li>
<li>Upload the docs to Google Cloud Storage</li>
<li>Update the metadata for the newly generated packages on Google Cloud Datastore</li>
</ul>


<p>Mostly, all of these are network calls (except actual generation of docs), so it&rsquo;d be dumb to do that sequently. But thanks to all the things about async and concurrency I desribed above, it could be done pretty easily! The HTTP lib and libs for working with Google Cloud services &ndash; they all return Futures, of course, so we can group them and then handle these groups in parallel. E.g., you could implement uploading to Google Cloud Storage in the following way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// Getting the list of all the generated docs files for [package]. This is actually non-blocking too!</span>
</span><span class='line'><span class="kd">var</span> <span class="n">files</span> <span class="o">=</span> <span class="n">await</span> <span class="n">_getListOfFilesForPackage</span><span class="p">(</span><span class="n">package</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Grouping files into groups of 20</span>
</span><span class='line'><span class="kd">var</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">inGroupsOf</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="m">20</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">Iterable</span> <span class="n">group</span> <span class="k">in</span> <span class="n">groups</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Upload every 20 files in parallel, waiting til that batch finishes uploading, then starting a new one</span>
</span><span class='line'>  <span class="n">await</span> <span class="n">Future</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">group</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="n">future</span> <span class="o">=</span> <span class="n">_uploadFileToGCS</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">future</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty simple, and easy to read and reason about. There is some room for improvement (you could queue all the uploads, and just make sure you handle 20 at a time, using some <a href="https://pub.dartlang.org/packages/tasks">task queue</a>, for example), but this example is simple enough to demonstrate the use case.</p>

<p>This non-blocking nature may be not so important for dartdocs.org, but it&rsquo;s becoming way more important when you use it in web services with HTTP front-end. Usually, you don&rsquo;t spend a lot of time and CPU on crunching numbers in a request, but instead you just make a lot of network calls to various services and databases, combine data together and return to the requester. Something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/sendNotificationsToUsers&quot;</span><span class="p">,</span> <span class="nl">methods:</span> <span class="kd">const</span> <span class="p">[</span><span class="n">app</span><span class="p">.</span><span class="n">POST</span><span class="p">])</span>
</span><span class='line'><span class="n">sendNotificationsToUsers</span><span class="p">(</span><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">Body</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">JSON</span><span class="p">)</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">userIds</span><span class="p">)</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">await</span> <span class="n">getUsersFromDatabase</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Iterable</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Future</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">user</span><span class="p">)</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sendEMailToUser</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}));</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">every</span><span class="p">((</span><span class="n">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">r</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">JSON</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">});</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">JSON</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="s2">&quot;failure&quot;</span><span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If every piece is non-blocking, the app spends very really little computation time on each request and has availability to process other concurrent requests. So you can process a lot of requests concurrently in a single thread. Which is great!</p>

<h2>Scalability</h2>

<p>Scalability in this context means &ndash; if we want to finish regenerating docs faster, we just need to launch more instances in the cloud. So, we need a way to split the work between them, and rebalance the work when we add or remove the instances.</p>

<p>Let&rsquo;s observe some properties of the pub Dart packages &ndash; each package is uniquely identified by its name and version. It&rsquo;s immutable &ndash; the source code of the package never changes. Also, the packages are never being deleted, all their versions will forever stay in pub. So, developers can only add new packages, so the list is always growing, but never shrinking.</p>

<p>I hosted the infrastructure on Google Cloud, on Google Compute Engine (GCE) instances. GCE has the ability to create instance groups, where you can specify how many instances should be run within that group. Each instance within that group will have a unique name, and you can get a list of all the instance names within a group. So, splitting the work in this case is pretty simple &ndash; after finishing generating docs for another batch of packages, we ask for the list of currently existing GCE instances within the group, sort it, check what&rsquo;s the current instance index within the list, and depending on that retrieve the next batch of packages from the whole list. I.e. if we have 5 instances in the group &ndash; foo1, foo2, foo3, foo4, and foo5. The current instance name is foo2. Whole number of unhandled packages is 10000. The batch size is 20 packages. Given all that, we&rsquo;ll take the range 2001-2020 from the list of all unhandled packages as the next batch.</p>

<p>Sometimes, when we increase or reduce number of instances in the group, we may end up with 2 instances generating docs for the same package, but that&rsquo;s fine &ndash; they will produce the same result and rare enough we can ignore that.</p>

<h2>Reliability</h2>

<p>The scripts should work unattended, and should try to restore themselves after failures. Also, there are a lot of network calls happening during the workflow of the script, so it should be tolerable to network failures, or external service failures. Also, in case of a failure, we need to know why the failure happened. We can achieve that by logging, timeouts, retries, and if we are out of retries, then just fail completely, and let something like <a href="https://mmonit.com/monit/">monit</a> to get us up and running again.</p>

<h3>Retries</h3>

<p>It&rsquo;s actually very simple to do &ndash; let&rsquo;s define this function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="kd">const</span> <span class="n">_defaultDurations</span> <span class="o">=</span> <span class="kd">const</span> <span class="p">[</span><span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">3</span><span class="p">),</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">5</span><span class="p">),</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">15</span><span class="p">)];</span>
</span><span class='line'><span class="n">Future</span> <span class="n">retry</span><span class="p">(</span><span class="n">body</span><span class="p">(),</span> <span class="p">{</span><span class="kt">int</span> <span class="nl">number:</span> <span class="m">3</span><span class="p">,</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Duration</span><span class="o">&gt;</span> <span class="nl">durations:</span> <span class="n">_defaultDurations</span><span class="p">)</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">await</span> <span class="n">body</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">durations</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="n">newDurations</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">durations</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">newDurations</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">newDurations</span><span class="p">.</span><span class="n">removeAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="n">Future</span><span class="p">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">retry</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nl">number:</span> <span class="n">number</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> <span class="nl">durations:</span> <span class="n">newDurations</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">rethrow</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, with any sync or async <code>body()</code>, in case it throws some exception, it will retry several times with specified durations, and then fail. We wrap every single network call into that retry, something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="k">import</span> <span class="s1">&#39;package:http/http.dart&#39;</span> <span class="k">as</span> <span class="n">http</span><span class="p">;</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="kd">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="n">http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">then</span><span class="p">((</span><span class="n">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">JSON</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">body</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, we lose the return type of <code>body()</code> in this case, this is would be a great use case for <a href="https://github.com/leafpetersen/dep-generic-methods/blob/master/proposal.md">method generics</a> (there is a <a href="https://github.com/dart-lang/sdk/issues/254">ticket</a> though).</p>

<p>Every network call in dartdocs.org scripts is wrapped with <code>retry()</code>, and it greatly reduces the number of failures, which may happen just because the network had problems or some service had occasional internal server error.</p>

<h3>Timeouts</h3>

<p>It&rsquo;s a good practice to specify meaningful timeouts for the things that are not under your control (like network calls, or external shell commands runs). There is the<code>Future.timeout()</code> method, which completes a future after specified duration, you use it somewhat like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="kd">var</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">timeout</span><span class="p">(</span><span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">10</span><span class="p">));</span>
</span><span class='line'><span class="kd">var</span> <span class="n">json</span> <span class="o">=</span> <span class="n">JSON</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>I used this approach everywhere at first, but then figured out that for the shell scripts it doesn&rsquo;t really work &ndash; if the shell script hangs, timeout fires, and the Dart script continues to run, but that script is not killed, it still hangs. So, a better approach would be to use <code>timeout</code> program, which kills the script and exits with non-zero status after specified timeout.</p>

<h3>Logging</h3>

<p>Sometimes things go wrong, and we need to know why. To figure out why we get some exception, it&rsquo;s usually not enough to have just that exception and the stack trace, you usually need to know what happened before that, that&rsquo;s why we need logging.</p>

<p>The most popular logging package in Dart is named (surprisingly!) <a href="https://pub.dartlang.org/packages/logging">logging</a>. The nice thing about it, that it gives a stream with  all the log records as part of its API, so you can subscribe to that stream and do whatever you want with it &ndash; write it to STDOUT, to a file, etc.</p>

<p>E.g., if we just want to print every log record into STDOUT, it may look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="kt">String</span> <span class="n">format</span><span class="p">(</span><span class="n">LogRecord</span> <span class="n">record</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="n">record</span><span class="p">.</span><span class="n">level</span><span class="si">}</span><span class="s2"> - </span><span class="si">${</span><span class="n">record</span><span class="p">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">Logger</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">onRecord</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">format</span><span class="p">).</span><span class="n">listen</span><span class="p">(</span><span class="n">print</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Debugging</h3>

<p>Since the code is async from the top to the bottom, in case of failure, what&rsquo;d you expect to see in the stacktrace? E.g. for this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="k">import</span> <span class="s1">&#39;dart:async&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">Future</span><span class="o">&lt;</span><span class="n">Null</span><span class="o">&gt;</span> <span class="n">blah</span><span class="p">()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">throw</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="k">new</span> <span class="n">Future</span><span class="p">(()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">await</span> <span class="k">new</span> <span class="n">Future</span><span class="p">(()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">await</span> <span class="n">blah</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Probably something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="n">Unhandled</span> <span class="nl">exception:</span>
</span><span class='line'><span class="n">Uncaught</span> <span class="nl">Error:</span> <span class="n">foo</span>
</span><span class='line'><span class="n">Stack</span> <span class="nl">Trace:</span>
</span><span class='line'><span class="err">#</span><span class="m">0</span>      <span class="n">blah</span><span class="p">.</span><span class="o">&lt;</span><span class="n">blah_async_body</span><span class="o">&gt;</span> <span class="p">(</span><span class="nl">file:</span><span class="c1">///Users/anton/projects/dartdocsorg/blah.dart:7:3)</span>
</span><span class='line'><span class="err">#</span><span class="m">1</span>      <span class="n">Future</span><span class="p">.</span><span class="n">Future</span><span class="p">.</span><span class="n">microtask</span><span class="p">.</span><span class="o">&lt;</span><span class="n">anonymous</span> <span class="n">closure</span><span class="o">&gt;</span> <span class="p">(</span><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span><span class="o">/</span><span class="n">future</span><span class="p">.</span><span class="nl">dart:</span><span class="m">144</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span><span class="m">2</span>      <span class="n">_microtaskLoop</span> <span class="p">(</span><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span><span class="o">/</span><span class="n">schedule_microtask</span><span class="p">.</span><span class="nl">dart:</span><span class="m">43</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span><span class="m">3</span>      <span class="n">_microtaskLoopEntry</span> <span class="p">(</span><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span><span class="o">/</span><span class="n">schedule_microtask</span><span class="p">.</span><span class="nl">dart:</span><span class="m">52</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span><span class="m">4</span>      <span class="n">_Timer</span><span class="p">.</span><span class="n">_runTimers</span> <span class="p">(</span><span class="nl">dart:</span><span class="n">isolate</span><span class="o">-</span><span class="n">patch</span><span class="o">/</span><span class="n">timer_impl</span><span class="p">.</span><span class="nl">dart:</span><span class="m">394</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span><span class="m">5</span>      <span class="n">_Timer</span><span class="p">.</span><span class="n">_handleMessage</span> <span class="p">(</span><span class="nl">dart:</span><span class="n">isolate</span><span class="o">-</span><span class="n">patch</span><span class="o">/</span><span class="n">timer_impl</span><span class="p">.</span><span class="nl">dart:</span><span class="m">414</span><span class="p">)</span>
</span><span class='line'><span class="err">#</span><span class="m">6</span>      <span class="n">_RawReceivePortImpl</span><span class="p">.</span><span class="n">_handleMessage</span> <span class="p">(</span><span class="nl">dart:</span><span class="n">isolate</span><span class="o">-</span><span class="n">patch</span><span class="o">/</span><span class="n">isolate_patch</span><span class="p">.</span><span class="nl">dart:</span><span class="m">148</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line shows where the exception happened, but we have no idea where we came from when we reached that line, making the stacktrace useless. This is what stack traces usually look like in heavily async programs, and that&rsquo;s one of the reasons why it&rsquo;s hard to debug them.</p>

<p>Thankfully, <a href="https://pub.dartlang.org/packages/stack_trace">stack_trace</a> package gives you the tools to solve that problem. If you wrap everything into <code>Chain.capture</code>, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="k">import</span> <span class="s1">&#39;package:stack_trace/stack_trace.dart&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">import</span> <span class="s1">&#39;dart:async&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">Future</span><span class="o">&lt;</span><span class="n">Null</span><span class="o">&gt;</span> <span class="n">blah</span><span class="p">()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">throw</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">Chain</span><span class="p">.</span><span class="n">capture</span><span class="p">(()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="k">new</span> <span class="n">Future</span><span class="p">(()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">await</span> <span class="k">new</span> <span class="n">Future</span><span class="p">(()</span> <span class="o">as</span><span class="n">ync</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">blah</span><span class="p">();</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">},</span> <span class="nl">onError:</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">print</span><span class="p">(</span><span class="n">chain</span><span class="p">.</span><span class="n">terse</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>you&rsquo;ll get way nicer stack traces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span> <span class="m">7</span><span class="o">:</span><span class="m">3</span>        <span class="n">blah</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">=====</span> <span class="o">as</span><span class="n">ynchronous</span> <span class="n">gap</span> <span class="o">===========================</span>
</span><span class='line'><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span>           <span class="n">_Completer</span><span class="p">.</span><span class="n">completeError</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span> <span class="m">10</span><span class="o">:</span><span class="m">1</span>       <span class="n">blah</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">=====</span> <span class="o">as</span><span class="n">ynchronous</span> <span class="n">gap</span> <span class="o">===========================</span>
</span><span class='line'><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span>           <span class="n">Future</span><span class="p">.</span><span class="n">Future</span><span class="p">.</span><span class="n">microtask</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span>            <span class="n">blah</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span> <span class="m">14</span><span class="o">:</span><span class="m">15</span>      <span class="n">main</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">=====</span> <span class="o">as</span><span class="n">ynchronous</span> <span class="n">gap</span> <span class="o">===========================</span>
</span><span class='line'><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span>           <span class="n">Future</span><span class="p">.</span><span class="n">Future</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span> <span class="m">13</span><span class="o">:</span><span class="m">17</span>      <span class="n">main</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">=====</span> <span class="o">as</span><span class="n">ynchronous</span> <span class="n">gap</span> <span class="o">===========================</span>
</span><span class='line'><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span>           <span class="n">Future</span><span class="p">.</span><span class="n">Future</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span> <span class="m">12</span><span class="o">:</span><span class="m">28</span>      <span class="n">main</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span><span class="p">.</span><span class="o">&lt;as</span><span class="n">ync</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">=====</span> <span class="o">as</span><span class="n">ynchronous</span> <span class="n">gap</span> <span class="o">===========================</span>
</span><span class='line'><span class="nl">dart:</span><span class="o">as</span><span class="n">ync</span>           <span class="n">Future</span><span class="p">.</span><span class="n">Future</span><span class="p">.</span><span class="n">microtask</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span>            <span class="n">main</span><span class="p">.</span><span class="o">&lt;</span><span class="n">fn</span><span class="o">&gt;</span>
</span><span class='line'><span class="nl">package:</span><span class="n">stack_trace</span>  <span class="n">Chain</span><span class="p">.</span><span class="n">capture</span>
</span><span class='line'><span class="n">blah</span><span class="p">.</span><span class="n">dart</span> <span class="m">11</span><span class="o">:</span><span class="m">9</span>       <span class="n">main</span>
</span></code></pre></td></tr></table></div></figure>


<p>It adds some performance and memory penalty, but it&rsquo;s neglectable for the dartdocs.org scripts, and simplifies debugging a lot.</p>

<h2>Summary</h2>

<p>All in all, it was a pretty straightforward project, and Dart didn&rsquo;t give me any unpleasant surprises, everything works just fine and as expected, and <a href="https://www.dartdocs.org/history/index.html">generates documentation for the new packages</a> every day. Check it out, if you haven&rsquo;t yet!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/18/dart-apps-with-unidirectional-flow-and-persistent-data-structures/">Dart Apps With Unidirectional Flow and Persistent Data Structures</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-18T01:05:46-05:00" pubdate data-updated="true">Oct 18<sup>th</sup>, 2014</time>
        
           | <a href="/blog/2014/10/18/dart-apps-with-unidirectional-flow-and-persistent-data-structures/#disqus_thread"
             data-disqus-identifier="http://astashov.github.io/blog/2014/10/18/dart-apps-with-unidirectional-flow-and-persistent-data-structures/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently in JavaScript, and especially in ClojureScript world, one approach of developing front-end apps became pretty popular &ndash; using unidirectional app flow and persistent data structures. Something pretty close to <a href="http://facebook.github.io/flux/docs/overview.html">Flux</a>, but not really exactly like it. I tried that approach in <a href="http://textik.com">Textik</a>, and was really happy how it went.</p>

<h2>The idea</h2>

<p>Here&rsquo;s the idea &ndash; in your app, you have only one place where you store <strong>ALL</strong> of your application state, some sort of global structure, containing persistent vectors and maps. It is important to use persistent data structures there, as you will see soon, they provide some very important features we use to speed up our app.</p>

<p>So, you have one global data structure, where the state of all your application is stored. Everything is there &ndash; what tooltips are shown, what buttons are disabled, all the content of the app, etc. Then, you pass that global data structure to your rendering engine, which renders the whole app, from top to bottom, for the first time. It also sets up various HTML events listeners to the DOM elements, and attaches event handlers, which basically do only one thing &ndash; they generate parameters payload, and pass it to Dispatcher.</p>

<p>Dispatcher receives that payload, and figures out what to do with it. It calls various &ldquo;mutators&rdquo; &ndash; models, which actually will change the global state of the app. Then, Dispatcher calls the rendering engine again, and passes the updated global state to it. The rendering engine rerenders the whole app again, from top to the bottom. But now, it can easily figure out what parts, or what components of the app should be rerendered. We pass particular subtrees of our global state tree to the components while rendering the whole app, and because these are persistent data structures, we can very quickly find out if some particular subtree was changed since last render. So, the rendering engine, using that knowledge, rerenders only parts of the app, which were changed, and because of that &ndash; it does that really fast.</p>

<p>And then everything happens in the same way again. We get another event, send the payload to Dispatcher, Dispatcher calls mutators, mutators change the global state, and Dispatcher calls the rendering engine to rerender the app again.</p>

<p>I.e., this way:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  main -------&gt; render view --------&gt; dispatcher
</span><span class='line'>                    ^                      |
</span><span class='line'>                    |                      |
</span><span class='line'>                    |                      v
</span><span class='line'>                    +------------ change global state</span></code></pre></td></tr></table></div></figure>


<p>So, this way we get a very simple data flow, all our events go through the same message bus to Dispatcher, the app structure becomes so simple, it is even ridiculous a bit :)</p>

<h2>Implementing TodoMVC in Dart</h2>

<p>So, I decided to try the same approach with Dart. I took ReactJS as the rendering engine, since it works really close to what I want from it, and there is a nice Dart wrapper for it from Clean Team &ndash; <a href="https://pub.dartlang.org/packages/react">react</a>. As for persistent data structures, there is a pub package from VacuumLabs &ndash; <a href="https://github.com/vacuumlabs/persistent">persistent</a> (but unfortunately it is not in Pub, you should get it from their forked repo from GitHub).</p>

<p>You can check the source code here: <a href="https://github.com/astashov/todomvc/tree/master/labs/architecture-examples/react-dart-uniflow/web/dart,">https://github.com/astashov/todomvc/tree/master/labs/architecture-examples/react-dart-uniflow/web/dart,</a> and you can play with it here: <a href="http://astashov.s3-us-west-2.amazonaws.com/todomvc/index.html">http://astashov.s3-us-west-2.amazonaws.com/todomvc/index.html</a> (if you want to check it in Dart, use Dartium). This is just usual TodoMVC app.</p>

<p>Let me quickly guide you through the code.</p>

<p>Everything starts with <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/data.dart#L86">initializing the global state</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// data.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="n">_appData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Data</span><span class="p">(</span><span class="n">persist</span><span class="p">({</span>
</span><span class='line'>    <span class="s1">&#39;autoincrement&#39;</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;new-input&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;list&#39;</span><span class="o">:</span> <span class="p">[],</span>
</span><span class='line'>    <span class="s1">&#39;filter&#39;</span><span class="o">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;edit&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">}));</span>
</span><span class='line'>
</span><span class='line'><span class="n">Data</span> <span class="kd">get</span> <span class="n">appData</span> <span class="o">=&gt;</span> <span class="n">_appData</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>appData</code> will be globally available, and we&rsquo;ll get the current value of the global state with <code>appData.value</code>.
There are a bunch of methods-mutators in the <code>Data</code> class, which will overwrite the <code>value</code> property of <code>appData</code> with the new value. They won&rsquo;t really mutate the existing <code>value</code>, but recreate the new one, reusing unchanged parts of the old <code>value</code>.</p>

<p>Then, we <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/app.dart#L46">initialize the app</a>, entering our <code>main()</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// app.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">setClientConfiguration</span><span class="p">();</span>
</span><span class='line'>  <span class="n">rerender</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>setClientConfiguration()</code> initializes the <code>react</code> library, and then we render the app for the first time. It happens in <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/dispatcher.dart#L12">dispatcher.dart</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// dispatcher.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">rerender</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">renderComponent</span><span class="p">(</span><span class="n">todoAppComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">appData</span><span class="p">.</span><span class="n">value</span><span class="p">}),</span> <span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;#todoapp&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we call <code>renderComponent</code>, which is a function of the <code>react</code> package, and pass the React component we are going to render and the selector which we are going to append it to.</p>

<p>The components are defined in the <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/components.dart#L41">components.dart</a> file.</p>

<p>All our components are not just default <code>React</code> components, but instead inherited from our custom <code>_Component</code> class, which we instrumented with the <code>shouldComponentUpdate</code> hook. There we check if the new passed value (our subtree of the global state) was changed since the last render. Again, this check should be very fast because of the persistent data structures properties. Also, as a convention, we are going to send our subtrees as the &lsquo;value&rsquo; prop.</p>

<p>Let&rsquo;s have a look at <code>todoAppComponent</code> &ndash; our entry component. All it does is just renders three subcomponents &ndash; header, footer and main, and pass parts of the received global tree to them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// components.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">TodoApp</span> <span class="kd">extends</span> <span class="n">_Component</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>      <span class="n">div</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;todo-app&#39;</span><span class="p">,</span> <span class="s1">&#39;className&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]},</span> <span class="p">[</span>
</span><span class='line'>        <span class="n">headerComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;new-input&quot;</span><span class="p">]}),</span>
</span><span class='line'>        <span class="n">mainComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">persist</span><span class="p">({</span>
</span><span class='line'>          <span class="s1">&#39;list&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;edit&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;edit&quot;</span><span class="p">]})}),</span>
</span><span class='line'>        <span class="n">footerComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">persist</span><span class="p">({</span>
</span><span class='line'>          <span class="s1">&#39;count&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;filter&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;countCompleted&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">].</span><span class="n">where</span><span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;isCompleted&quot;</span><span class="p">]).</span><span class="n">length</span><span class="p">})})]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="n">todoAppComponent</span> <span class="o">=</span> <span class="n">registerComponent</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">TodoApp</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s have a look e.g. at <code>headerComponent</code>, which renders the input for creating new tasks, and also adds event handlers to the input. It only receives the <code>appData.value['new-input']</code> value, which defines what should be the value of the input.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// components.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Header</span> <span class="kd">extends</span> <span class="n">_Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">_inputChange</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dispatch</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="o">:</span> <span class="s1">&#39;new-input&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">event</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">value</span><span class="p">});</span>
</span><span class='line'>    <span class="n">setState</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">event</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">value</span><span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>      <span class="n">header</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;header&#39;</span><span class="p">},</span> <span class="p">[</span>
</span><span class='line'>        <span class="n">h1</span><span class="p">({},</span> <span class="s1">&#39;todos&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">input</span><span class="p">({</span>
</span><span class='line'>          <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;new-todo&#39;</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="o">:</span> <span class="s1">&#39;What needs to be done?&#39;</span><span class="p">,</span> <span class="s1">&#39;autofocus&#39;</span><span class="o">:</span> <span class="s1">&#39;autofocus&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;onChange&#39;</span><span class="o">:</span> <span class="n">_inputChange</span><span class="p">,</span> <span class="s1">&#39;onKeyDown&#39;</span><span class="o">:</span> <span class="n">_onKeyDown</span><span class="p">})]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="n">headerComponent</span> <span class="o">=</span> <span class="n">registerComponent</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">Header</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Every single time we enter/remove a character in the input, we fire an event, and its handler <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/dispatcher.dart#L19">calls the dispatch function</a> of Dispatcher. We send the payload to it, which looks like <code>{'action': 'new-input', 'value': input.value}</code>.</p>

<p>There, in Dispatcher, we handle it. For simplicity, I mutate the global state right in Dispatcher, but in a larger application you probably would want to delegate that to a model.</p>

<p>And then, we rerender the app again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// dispatcher.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">dispatch</span><span class="p">(</span><span class="n">Map</span> <span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">case</span> <span class="s1">&#39;new-input&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="n">appData</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;new-input&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">rerender</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Summary</h2>

<p>So, that&rsquo;s actually it. Of course there are also other functionality &ndash; editing items, removing items, marking as completed, etc, but it works just in the same way as I just described. For items, there is the <code>Item</code> model &ndash; <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/models/item.dart">items.dart</a>, which provides API for CRUD operations for items. But all that stuff works in the same way I just described.</p>

<p>That&rsquo;s the whole lifecycle of the application. Very simple, very declarative &ndash; you basically only need to work with the global state, changing it accordingly, and you don&rsquo;t really need to care about the view &ndash; React will do a great job with rendering the app using the global state.</p>

<p>Another cool side-effect of having the global state &ndash; you can always easily reproduce your user&rsquo;s problems &ndash; debugging becomes way easier! If you use something like Airbrake or Rollbar to aggregate exceptions from your users, then you could just attach the global state in JSON to the exception you are about to send to e.g. Rollbar, and then you can easily reproduce the user&rsquo;s problem just by applying that JSON on your machine, so you&rsquo;d get exactly the same state of the app where the user was before the exception happened. Kinda cool, huh? :)</p>

<p>There are a bunch of other cool things (e.g. simple undo &ndash; you can just save the full state of the app (or part of the state) in a vector every time the change happens, and it will be stored efficiently because of the nature of persistent data structures).</p>

<p>I&rsquo;m really excited about this approach so far.</p>

<h2>Isn&rsquo;t that like Rails?</h2>

<p>If you ever worked with Rails, you can actually see a lot of similar things in this approach. In Rails, we pass our request through router, then router figures out (from URLs and GET params) what controller this request should be sent to, controller calls various models, which change the database, and the render the response. In this case,</p>

<ul>
<li>Dispatcher is router</li>
<li>&lsquo;mutators&rsquo; are models</li>
<li>appData is our database</li>
</ul>


<p>In models, we also don&rsquo;t have our internal state, models work with the database, retrieving and saving data into it.
Same as in ActiveRecord :)</p>

<p>And the whole lifecycle of the front-end app like this one and a Rails app looks extremely familiar. :)</p>

<hr />


<p>There are still some things, that could be improved, and some additional persistent data structures, that could be written, like e.g. currently PersistentVector doesn&rsquo;t efficiently handle inserting/removing elements in the middle of a vector. But still, you already can do a lot with the Dart ecosystem and these 2 packages I was talking about &ndash; <code>react</code> and <code>persistent</code>.</p>

<p>So, please try it out, hopefully you&rsquo;ll find it useful :)</p>

<h2>Related links</h2>

<ul>
<li><a href="https://pub.dartlang.org/packages/react">React</a></li>
<li><a href="https://github.com/vacuumlabs/persistent">Persistent</a> &ndash; btw, there is a great explanation why persistent data structures are cool, make sure you&rsquo;ve read that!</li>
<li><a href="https://github.com/astashov/todomvc/tree/master/labs/architecture-examples/react-dart-uniflow/web/dart">Source code</a></li>
<li><a href="http://astashov.s3-us-west-2.amazonaws.com/todomvc/index.html">Demo</a> (Dartium only)</li>
<li><a href="http://www.slideshare.net/AntonAstashov/textik">Slides of my Textik talk</a> &ndash; where I was talking about the Textik&rsquo;s architecture, which is very close to what I described dhere.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/30/perfect-clojurescript-development-environment-with-vim/">Perfect ClojureScript Development Environment With Vim</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-30T19:28:27-05:00" pubdate data-updated="true">Jul 30<sup>th</sup>, 2014</time>
        
           | <a href="/blog/2014/07/30/perfect-clojurescript-development-environment-with-vim/#disqus_thread"
             data-disqus-identifier="http://astashov.github.io/blog/2014/07/30/perfect-clojurescript-development-environment-with-vim/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When I just started to learn ClojureScript, I had hard time trying to find some tutorials which could explain how to set up a nice dev environment for ClojureScript. The good environment is extremely important especially when you just started to play around with the language, it is very useful to get immediate feedback to your changes in the code. But it&rsquo;s also helpful when you already know what you do, and allows you to iterate quickly on your project.</p>

<p>Later, while working on <a href="http://textik.com">Textik</a> (check it out, or check the <a href="http://github.com/astashov/tixi">sources</a>), I was able to build something close enough to the ideal environment, which could allow me to iterate very quickly. To simplify life of ClojureScript beginners, here&rsquo;s a tutorial how to set up that kind of environment.</p>

<p>So, here is a detailed explanation what you need to do from the scratch, or you could just go and clone/fork <a href="http://github.com/astashov/perfection">the skeleton project</a> on Github, if you feel more like tl;dr.</p>

<p>I used Vim for development, but most of this tutorial (except the Vim part) is IDE-agnostic.</p>

<p>To start, let&rsquo;s create a new Clojure project, called &lsquo;perfection&rsquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein new perfection
</span></code></pre></td></tr></table></div></figure>


<p>It will create a skeleton of a Clojure project. Then, open project.clj file, it should look something like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add some lines to turn the project into a ClojureScript project:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adding ClojureScript</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span> <span class="c1">;; &lt;- Sometimes ClojureScript compilation fails because available</span>
</span><span class='line'>                       <span class="c1">;; JVM heap space it too low. This line gives it more space</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- While you can build ClojureScript just by running</span>
</span><span class='line'>                                      <span class="c1">;;    &#39;cljsc&#39;, there is a waaay more convenient way -</span>
</span><span class='line'>                                      <span class="c1">;;    using cljsbuild lein plugin</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">;; This is the list of builds &#39;cljsbuild&#39; will use to compile our ClojureScript</span>
</span><span class='line'>  <span class="c1">;; code into JavaScript. Here we add first build &quot;dev&quot;, it will put resulting main</span>
</span><span class='line'>  <span class="c1">;; entry for JavaScript code to resources/public/perfection.js, and all dependencies</span>
</span><span class='line'>  <span class="c1">;; for it to resources/public/out</span>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, run</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein deps
</span></code></pre></td></tr></table></div></figure>


<p>And <code>lein</code> will install all the new dependencies we just added.</p>

<p>Next, delete the file <code>src/perfection/core.clj</code>, create a new file <code>src/perfection/core.cljs</code>, and put simple &ldquo;Hello World&rdquo; code into it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection.core</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need something to run our compiled JavaScript code. Let&rsquo;s create the index.html file, which will include the generated JavaScript file. Create <code>resources/public/index.html</code> file and add something like this to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;out/goog/base.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection.core&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s also add some styles, create the <code>resources/public/css/styles.css</code> CSS file with this content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="nb">silver</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try to run compilation, via &lsquo;cljsbuild&rsquo; lein plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein cljsbuild auto dev
</span><span class='line'>Compiling ClojureScript.
</span><span class='line'>Compiling <span class="s2">&quot;resources/public/perfection.js&quot;</span> from <span class="o">[</span><span class="s2">&quot;src&quot;</span><span class="o">]</span>...
</span><span class='line'>Successfully compiled <span class="s2">&quot;resources/public/perfection.js&quot;</span> in 6.829 seconds.
</span></code></pre></td></tr></table></div></figure>


<p>Now we need some server to serve our files. I usually prefer to use Python&rsquo;s SimpleHTTPServer:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python -m SimpleHTTPServer 8000
</span></code></pre></td></tr></table></div></figure>


<p>Next, open a browser and go to <code>http://localhost:8000/resources/public/index.html</code>. Check the console, you should see &ldquo;Hello World!&rdquo; there.</p>

<h2>Figwheel</h2>

<p>Now, you have some running ClojureScript environment, which will automatically and instantly (less than for a second) recompile your files when you change any files in &lsquo;src/perfection&rsquo; directory. Sweet. But we want more.</p>

<p>Meet <a href="https://github.com/bhauman/lein-figwheel">lein-figwheel</a>, amazing lein plugin, which will reload the changed JavaScript files after recompilation in the browser <strong>without</strong> reloading the page! That is so cool. Let&rsquo;s add it to our project:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span> <span class="c1">;; &lt;- Adding Figwheel</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adding also a lein plugin for it</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">;; Figwheel settings. We are going to use &#39;resource/public&#39; directory as our root</span>
</span><span class='line'>  <span class="c1">;; directory for serving the files by the figwheel server, and also we specify</span>
</span><span class='line'>  <span class="c1">;; where our CSS styles live, so Figwheel could reload them without reloading the</span>
</span><span class='line'>  <span class="c1">;; page when we change them as well!</span>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span><span class="p">]</span> <span class="c1">;; &lt;- adding source path where</span>
</span><span class='line'>                                                              <span class="c1">;;    figwheel code will live</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will place the client code for figwheel not in <code>src/perfection</code>, but in a separate dir, because we don&rsquo;t want other builds (like &lsquo;test&rsquo; or &lsquo;release&rsquo;) to include it.</p>

<p>Now, create the file <code>src/figwheel/perfecton_figwheel.cljs</code>, and put this code there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection-figwheel</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">figwheel.client</span> <span class="ss">:as</span> <span class="nv">fw</span> <span class="ss">:include-macros</span> <span class="nv">true</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fw/watch-and-reload</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And require it from <code>resources/public/index.html</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;out/goog/base.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection.core&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- Requiring figwheel --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection_figwheel&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, let&rsquo;s shut down our python server, but run</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein figwheel dev
</span></code></pre></td></tr></table></div></figure>


<p>instead, then open localhost:3449/index.html in the browser, and check the console. It should look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Hello world!
</span><span class='line'>Figwheel: trying to open cljs reload socket
</span><span class='line'>Figwheel: socket connection established
</span></code></pre></td></tr></table></div></figure>


<p>Now go to src/perfection/core.cljs, and change it to something else, e.g. change &ldquo;Hello World!&rdquo; to &ldquo;Hello World 2!&rdquo;. You should see in the console, that we reloaded our files, and the new &ldquo;Hello World 2!&rdquo; output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Figwheel: loading files
</span><span class='line'>Hello world 2!
</span><span class='line'>Figwheel: loaded these files
</span><span class='line'><span class="o">(</span><span class="s2">&quot;/out/perfection/core.js&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Figwheel will also track the changes in CSS and also reload them. Change the background in the CSS file from silver to blue (<code>resources/public/css/style.css</code> file):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and you&rsquo;ll see in the browser console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">Figwheel</span><span class="o">:</span> <span class="nt">loaded</span> <span class="nt">CSS</span> <span class="nt">files</span>
</span><span class='line'><span class="o">(</span><span class="s2">&quot;/css/style.css&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Tests</h2>

<p>I like unit tests. They give me confidence. But it really sucks to manually run them every time, and it especially sucks to run them in Clojure/ClojureScript, because you have to wait for the full JVM start, which takes several seconds. Not really perfect instant experience we are looking for. Thankfully, you can run it once, and then restart the tests on every change of the source or test files, via the same &lsquo;lein clsbuild auto&rsquo; mechanism.</p>

<p>First thing, make sure you have <strong>PhantomJS</strong> installed. If not, install it with HomeBrew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install phantomjs
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&rsquo;s add the &lsquo;test&rsquo; build for <code>cljsbuild</code>, in <code>project.clj</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adding lein plugin for tests</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}</span>
</span><span class='line'>             <span class="c1">;; Adding the new build &#39;test&#39;. Note the :notify-command setting,</span>
</span><span class='line'>             <span class="c1">;; it will run the tests when the files change</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:cljs.test/runner</span> <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;perfection_test.js&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:whitespace</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s add some function to test (<code>src/perfection/core.cljs</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection.core</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="s">&quot;Hello world 2!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Our new function</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">b</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, remove the currently existing <code>test/perfection/core_test.clj</code>, and create a new file <code>test/perfection/core_test.cljs</code>, which will contain our new first failing test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection.core-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">is</span> <span class="nv">deftest</span><span class="p">)])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:as</span> <span class="nv">test</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">perfection.core</span> <span class="ss">:as</span> <span class="nv">pn</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">deftest</span> <span class="nv">ex1</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">pn/add</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">4</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try to run it. It should fail:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein cljsbuild auto <span class="nb">test</span>
</span><span class='line'>Compiling ClojureScript.
</span><span class='line'>Compiling <span class="s2">&quot;perfection_test.js&quot;</span> from <span class="o">[</span><span class="s2">&quot;src/perfection&quot;</span> <span class="s2">&quot;test&quot;</span><span class="o">]</span>...
</span><span class='line'>SyntaxError: Parse error
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Testing perfection.core-test
</span><span class='line'>
</span><span class='line'>FAIL in <span class="o">(</span>perfection.core-test/ex1<span class="o">)</span> <span class="o">(</span>:<span class="o">)</span>
</span><span class='line'>expected: <span class="o">(=</span> <span class="o">(</span>pn/add 1 2<span class="o">)</span> 4<span class="o">)</span>
</span><span class='line'>  actual: <span class="o">(</span>not <span class="o">(=</span> 3 4<span class="o">))</span>
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 1 failures, 0 errors.
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 1 failures, 0 errors.
</span><span class='line'>Successfully compiled <span class="s2">&quot;perfection_test.js&quot;</span> in 4.203 seconds.
</span></code></pre></td></tr></table></div></figure>


<p>Change <code>(is (= (pn/add 1 2) 4))</code> to <code>(is (= (pn/add 1 2) 3))</code>, then save the file, and the test should rerun automatically, and now it should pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Compiling <span class="s2">&quot;perfection_test.js&quot;</span> from <span class="o">[</span><span class="s2">&quot;src/perfection&quot;</span> <span class="s2">&quot;test&quot;</span><span class="o">]</span>...
</span><span class='line'>SyntaxError: Parse error
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Testing perfection.core-test
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 0 failures, 0 errors.
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 0 failures, 0 errors.
</span><span class='line'>Successfully compiled <span class="s2">&quot;perfection_test.js&quot;</span> in 0.719 seconds.
</span></code></pre></td></tr></table></div></figure>


<p>W00t! Now we have an autorunning test in our app.</p>

<p>Some notes: PhantomJS is pretty old, it lacks a lot of features existing in modern browsers, like <code>Function.bind</code> or <code>requestAnimationFrame</code>. So, for tests you may need shims, you can write them in separate JS files, and then add to <code>:notify-command</code> in <code>project.clj</code> for the &ldquo;test&rdquo; build, e.g. like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span>
</span><span class='line'>                 <span class="ss">:cljs.test/runner</span>
</span><span class='line'>                 <span class="s">&quot;resources/public/js/function-bind-shim.js&quot;</span>
</span><span class='line'>                 <span class="s">&quot;resources/public/js/request-animation-frame-shim.js&quot;</span>
</span><span class='line'>                 <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Integration with Vim</h2>

<p>We already have a lot, but we are not going to stop :). We would also want to quickly search docs for the functions we use from Vim, be able to jump to definitions of the functions, and even execute some code right in the browser&rsquo;s context, right in the context of our running application, straight from Vim. Oh yes, that would be super cool. And that is totally possible, all thanks to famous Vim master Tim Pope and his beautiful &lsquo;vim-fireplace&rsquo; plugin.</p>

<p>So, let&rsquo;s first configure our app so it could accept connections from repl. We need to install brepl to it. As usual, we first need to add some changes to <code>project.clj</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/austin</span> <span class="s">&quot;0.1.4&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adds nice support for ClojureScript REPL.</span>
</span><span class='line'>                                           <span class="c1">;;    Also has Piggieback as a dependency, which</span>
</span><span class='line'>                                           <span class="c1">;;    we need for vim-fireplace</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span> <span class="s">&quot;src/brepl&quot;</span><span class="p">]</span>  <span class="c1">;; &lt;- adding source path</span>
</span><span class='line'>                                                                           <span class="c1">;;    where brepl code</span>
</span><span class='line'>                                                                           <span class="c1">;;    will live</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:cljs.test/runner</span> <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;perfection_test.js&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:whitespace</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same thing as for figwheel &ndash; we will place the client code for brepl not in <code>src/perfection</code>, but in a separate dir, because we don&rsquo;t want other builds (like &lsquo;test&rsquo; or &lsquo;release&rsquo;) to include it.</p>

<p>Now, create <code>src/brepl/perfection_brepl.cljs</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection-brepl</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.browser.repl</span> <span class="ss">:as</span> <span class="nv">repl</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">repl/connect</span> <span class="s">&quot;http://localhost:9000/repl&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And add its requiring to <code>resources/public/index.html</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;out/goog/base.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection.core&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection_figwheel&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- Requiring brepl --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection_brepl&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, restart <code>lein figwheel dev</code>, then run <code>lein repl</code>.</p>

<p>Now, it&rsquo;s time to install the vim-fireplace plugin for Vim. I use <code>pathogen</code>, so I just simply put the plugin to <code>~/.vim/bundle/vim-fireplace</code>.</p>

<p>Next, restart Vim, open <code>src/perfection/core.cljs</code>, and in Vim run <code>:Piggieback 9000</code>. It will hang for several seconds.</p>

<p>Then reload <code>localhost:3449/index.html</code> in browser.</p>

<p>You may see the exception in the browser console, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>Uncaught SecurityError: Failed to read the &#39;contentDocument&#39; property from &#39;HTMLIFrameElement&#39;:
</span><span class='line'>Blocked a frame with origin &quot;http://localhost:3449&quot; from accessing a frame with origin
</span><span class='line'>&quot;http://localhost:9000&quot;. Protocols, domains, and ports must match.
</span></code></pre></td></tr></table></div></figure>


<p>but that&rsquo;s totally fine, and will work anyway.</p>

<p>Go back to <code>src/perfection/core.cljs</code> in Vim, and try to run something like <code>:Eval (js/alert 123)</code>. The alert window should appear right in the browser. Cool, huh?</p>

<p>You can do a lot of things with vim-fireplace, just check the docs. It converts Vim to a pretty solid ClojureScript IDE, which now is quite close even to LightTable, but with all that well-known Vim stuff you and me love so much :)</p>

<h2>Release</h2>

<p>Now we have everything we need for comfortable development process, but I highly recommend that you also add another build, which will generate the &ldquo;release&rdquo; version of the app, which will eventually go to production. It is very important to do that right from the beginning, because sometimes there are issues with &ldquo;advanced&rdquo; optimizations of Google Closure (which ClojureScript uses under the hood for compilation). You should really always check that your app works with :advanced optimizations, because debugging may be difficult there.</p>

<p>So, add this to your <code>project.clj</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/austin</span> <span class="s">&quot;0.1.4&quot;</span><span class="p">]]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span> <span class="s">&quot;src/brepl&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:cljs.test/runner</span> <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;perfection_test.js&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:whitespace</span><span class="p">}}</span>
</span><span class='line'>             <span class="c1">;; Our release build. The main difference - it uses :optimizations :advanced.</span>
</span><span class='line'>             <span class="c1">;; It also doesn&#39;t include src/figwheel or src/brepl - we don&#39;t need that in production</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;release&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection_prod.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/prod-out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:advanced</span>
</span><span class='line'>                <span class="ss">:pretty-print</span> <span class="nv">false</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="s">&quot;resources/public/perfection_prod.js.map&quot;</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now create <code>resources/public/index_prod.html</code>, it&rsquo;s going to be way shorter than our dev one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection_prod.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein cljsbuild auto release
</span></code></pre></td></tr></table></div></figure>


<p>Now you can open <code>http://localhost:3449/index_prod.html</code>, and make sure the site still works (by checking for &ldquo;Hello World 2!&rdquo; in the console.</p>

<p>BTW, now if you open <code>resources/public/perfection_prod.js</code>, all you will see there is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">;(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hello world 2!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//# sourceMappingURL=perfection_prod.js.map</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s the power of :advanced optimizations. It got rid of everything which is not used (all the ClojureScript libs, Google Closure libs, thousands and thousands of lines of code), and left only what matters.</p>

<h2>Summary</h2>

<p>So, I usually have 4 things running simultaneously:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">lein</span> <span class="nx">repl</span>
</span><span class='line'><span class="nx">lein</span> <span class="nx">figwheel</span> <span class="nx">dev</span>
</span><span class='line'><span class="nx">lein</span> <span class="nx">cljsbuild</span> <span class="nx">auto</span> <span class="nx">test</span>
</span><span class='line'><span class="nx">lein</span> <span class="nx">cljsbuild</span> <span class="nx">auto</span> <span class="nx">release</span>
</span></code></pre></td></tr></table></div></figure>


<p>And whenever I make a change in the source code, I&rsquo;ll get updated version of the app in the browser, without page refresh, the tests will run, and the release will be built. All automagically.</p>

<p>That&rsquo;s what I call &ldquo;the perfect dev environment&rdquo;.</p>

<h2>Tips &amp; Tricks</h2>

<h3>Paredit</h3>

<p>You should use it. Since Clojure is Lisp, and consists of s-expressions, it has a very clear structure. Paredit allows to efficiently edit your code by manipulating s-expressions. This is when all these parentheses, which initially scare Lisp newcomers, will bring power. There is a plugin for Vim, a bit buggy, especially when you copy/paste large structures (especially when they are unbalanced), but it&rsquo;s still worth it.</p>

<h3><code>p</code> and <code>b</code></h3>

<p>I found it very useful for my development process to create the function <code>p</code> and the macro <code>b</code> for debugging.</p>

<ul>
<li><code>p</code> just prints what the value it receives and returns it.</li>
<li><code>b</code> prints what time did the execution of the nested s-expression take, and also returns the value.</li>
</ul>


<p>They look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">p</span> <span class="s">&quot;Prints given arguments, and then returns the last one&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">values</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="p">(</span><span class="nb">apply pr-str </span><span class="nv">values</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">last </span><span class="nv">values</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">benchmark</span>
</span><span class='line'>  <span class="s">&quot;Prints the execution time for the given function. Accepts optional string, which will</span>
</span><span class='line'><span class="s">   be used as a description&quot;</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">f</span><span class="p">]</span> <span class="p">(</span><span class="nf">benchmark</span> <span class="nv">nil</span> <span class="nv">f</span><span class="p">))</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">msg</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">start</span> <span class="p">(</span><span class="nf">.now</span> <span class="nv">js/Date</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">result</span> <span class="p">(</span><span class="nf">f</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">p</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nb">when </span><span class="nv">msg</span> <span class="p">(</span><span class="nb">str </span><span class="nv">msg</span> <span class="s">&quot;: &quot;</span><span class="p">))</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">.now</span> <span class="nv">js/Date</span><span class="p">)</span> <span class="nv">start</span><span class="p">)</span> <span class="s">&quot;ms&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">result</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">b</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">tixi.utils/benchmark</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="o">~</span><span class="nv">f</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">([</span><span class="nv">msg</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">tixi.utils/benchmark</span> <span class="o">~</span><span class="nv">msg</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="o">~</span><span class="nv">f</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then we can use them, like that. Imagine you have a function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">foo</span> <span class="mi">2</span>
</span><span class='line'>      <span class="nv">bar</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="nv">foo</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">foo</span> <span class="nv">bar</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And you are curious about what&rsquo;s the output of <code>(+ 3 foo)</code>. So you can do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">foo</span> <span class="mi">2</span>
</span><span class='line'>      <span class="nv">bar</span> <span class="p">(</span><span class="nf">p</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="nv">foo</span><span class="p">))]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">foo</span> <span class="nv">bar</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it will put &lsquo;5&rsquo; in the browser console. Curious how long it takes to execute it?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">foo</span> <span class="mi">2</span>
</span><span class='line'>      <span class="nv">bar</span> <span class="p">(</span><span class="nf">b</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="nv">foo</span><span class="p">))]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">foo</span> <span class="nv">bar</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>&lsquo;0ms&rsquo; (obviously :)) will appear in the browser console.</p>

<p>It starts to really shine especially with Paredit, when you can wrap and unwrap parentheses by one keystroke.</p>

<h3>Video</h3>

<p>This is a little screencast I recorded how I develop <a href="http://textik.com">Textik</a>, using the dev environment like that:</p>

<iframe width="835" height="626" src="//www.youtube.com/embed/IWexDxLnnak" frameborder="0" allowfullscreen></iframe>


<h2>Conclusion</h2>

<p>I really think ClojureScript so far is the most interesting and productive way to build complex front-end projects on the web. Especially if you use it with React (and some React wrapper, like <a href="https://github.com/swannodette/om">Om</a>, <a href="https://github.com/holmsand/reagent">Reagent</a> or <a href="https://github.com/levand/quiescent">Quiescent</a>). If you didn&rsquo;t try it yet, you should definitely try, and then hopefully you&rsquo;ll find this article useful :)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Anton Astashov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'astashovsblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
