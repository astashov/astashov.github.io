
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Anton Astashov's blog</title>
  <meta name="author" content="Anton Astashov">

  
  <meta name="description" content="Recently in JavaScript, and especially in ClojureScript world, one approach of developing front-end apps became pretty popular &ndash; using &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://astashov.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Anton Astashov's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20358438-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Anton Astashov's blog</a></h1>
  
    <h2>Would be nice to write something clever here.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
  
  
  
  
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:astashov.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/17/dart-apps-with-unidirectional-flow-and-persistent-data-structures/">Dart Apps With Unidirectional Flow and Persistent Data Structures</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-17T23:05:46-07:00" pubdate data-updated="true">Oct 17<sup>th</sup>, 2014</time>
        
           | <a href="/blog/2014/10/17/dart-apps-with-unidirectional-flow-and-persistent-data-structures/#disqus_thread"
             data-disqus-identifier="http://astashov.github.io/blog/2014/10/17/dart-apps-with-unidirectional-flow-and-persistent-data-structures/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently in JavaScript, and especially in ClojureScript world, one approach of developing front-end apps became pretty popular &ndash; using unidirectional app flow and persistent data structures. Something pretty close to <a href="http://facebook.github.io/flux/docs/overview.html">Flux</a>, but not really exactly like it. I tried that approach in <a href="http://textik.com">Textik</a>, and was really happy how it went.</p>

<h2>The idea</h2>

<p>Here&rsquo;s the idea &ndash; in your app, you have only one place where you store <strong>ALL</strong> of your application state, some sort of global structure, containing persistent vectors and maps. It is important to use persistent data structures there, as you will see soon, they provide some very important features we use to speed up our app.</p>

<p>So, you have one global data structure, where the state of all your application is stored. Everything is there &ndash; what tooltips are shown, what buttons are disabled, all the content of the app, etc. Then, you pass that global data structure to your rendering engine, which renders the whole app, from top to bottom, for the first time. It also sets up various HTML events listeners to the DOM elements, and attaches event handlers, which basically do only one thing &ndash; they generate parameters payload, and pass it to Dispatcher.</p>

<p>Dispatcher receives that payload, and figures out what to do with it. It calls various &ldquo;mutators&rdquo; &ndash; models, which actually will change the global state of the app. Then, Dispatcher calls the rendering engine again, and passes the updated global state to it. The rendering engine rerenders the whole app again, from top to the bottom. But now, it can easily figure out what parts, or what components of the app should be rerendered. We pass particular subtrees of our global state tree to the components while rendering the whole app, and because these are persistent data structures, we can very quickly find out if some particular subtree was changed since last render. So, the rendering engine, using that knowledge, rerenders only parts of the app, which were changed, and because of that &ndash; it does that really fast.</p>

<p>And then everything happens in the same way again. We get another event, send the payload to Dispatcher, Dispatcher calls mutators, mutators change the global state, and Dispatcher calls the rendering engine to rerender the app again.</p>

<p>I.e., this way:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  main -------&gt; render view --------&gt; dispatcher
</span><span class='line'>                    ^                      |
</span><span class='line'>                    |                      |
</span><span class='line'>                    |                      v
</span><span class='line'>                    +------------ change global state</span></code></pre></td></tr></table></div></figure>


<p>So, this way we get a very simple data flow, all our events go through the same message bus to Dispatcher, the app structure becomes so simple, it is even ridiculous a bit :)</p>

<h2>Implementing TodoMVC in Dart</h2>

<p>So, I decided to try the same approach with Dart. I took ReactJS as the rendering engine, since it works really close to what I want from it, and there is a nice Dart wrapper for it from Clean Team &ndash; <a href="https://pub.dartlang.org/packages/react">react</a>. As for persistent data structures, there is a pub package from VacuumLabs &ndash; <a href="https://github.com/vacuumlabs/persistent">persistent</a> (but unfortunately it is not in Pub, you should get it from their forked repo from GitHub).</p>

<p>You can check the source code here: <a href="https://github.com/astashov/todomvc/tree/master/labs/architecture-examples/react-dart-uniflow/web/dart,">https://github.com/astashov/todomvc/tree/master/labs/architecture-examples/react-dart-uniflow/web/dart,</a> and you can play with it here: <a href="http://astashov.s3-us-west-2.amazonaws.com/todomvc/index.html">http://astashov.s3-us-west-2.amazonaws.com/todomvc/index.html</a> (if you want to check it in Dart, use Dartium). This is just usual TodoMVC app.</p>

<p>Let me quickly guide you through the code.</p>

<p>Everything starts with <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/data.dart#L86">initializing the global state</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// data.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="n">_appData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Data</span><span class="p">(</span><span class="n">persist</span><span class="p">({</span>
</span><span class='line'>    <span class="s1">&#39;autoincrement&#39;</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;new-input&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;list&#39;</span><span class="o">:</span> <span class="p">[],</span>
</span><span class='line'>    <span class="s1">&#39;filter&#39;</span><span class="o">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;edit&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">}));</span>
</span><span class='line'>
</span><span class='line'><span class="n">Data</span> <span class="kd">get</span> <span class="n">appData</span> <span class="o">=&gt;</span> <span class="n">_appData</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>appData</code> will be globally available, and we&rsquo;ll get the current value of the global state with <code>appData.value</code>.
There are a bunch of methods-mutators in the <code>Data</code> class, which will overwrite the <code>value</code> property of <code>appData</code> with the new value. They won&rsquo;t really mutate the existing <code>value</code>, but recreate the new one, reusing unchanged parts of the old <code>value</code>.</p>

<p>Then, we <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/app.dart#L46">initialize the app</a>, entering our <code>main()</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// app.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">setClientConfiguration</span><span class="p">();</span>
</span><span class='line'>  <span class="n">rerender</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>setClientConfiguration()</code> initializes the <code>react</code> library, and then we render the app for the first time. It happens in <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/dispatcher.dart#L12">dispatcher.dart</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// dispatcher.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">rerender</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">renderComponent</span><span class="p">(</span><span class="n">todoAppComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">appData</span><span class="p">.</span><span class="n">value</span><span class="p">}),</span> <span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;#todoapp&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we call <code>renderComponent</code>, which is a function of the <code>react</code> package, and pass the React component we are going to render and the selector which we are going to append it to.</p>

<p>The components are defined in the <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/components.dart#L41">components.dart</a> file.</p>

<p>All our components are not just default <code>React</code> components, but instead inherited from our custom <code>_Component</code> class, which we instrumented with the <code>shouldComponentUpdate</code> hook. There we check if the new passed value (our subtree of the global state) was changed since the last render. Again, this check should be very fast because of the persistent data structures properties. Also, as a convention, we are going to send our subtrees as the &lsquo;value&rsquo; prop.</p>

<p>Let&rsquo;s have a look at <code>todoAppComponent</code> &ndash; our entry component. All it does is just renders three subcomponents &ndash; header, footer and main, and pass parts of the received global tree to them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// components.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">TodoApp</span> <span class="kd">extends</span> <span class="n">_Component</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>      <span class="n">div</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;todo-app&#39;</span><span class="p">,</span> <span class="s1">&#39;className&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]},</span> <span class="p">[</span>
</span><span class='line'>        <span class="n">headerComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;new-input&quot;</span><span class="p">]}),</span>
</span><span class='line'>        <span class="n">mainComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">persist</span><span class="p">({</span>
</span><span class='line'>          <span class="s1">&#39;list&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;edit&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;edit&quot;</span><span class="p">]})}),</span>
</span><span class='line'>        <span class="n">footerComponent</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">persist</span><span class="p">({</span>
</span><span class='line'>          <span class="s1">&#39;count&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;filter&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">],</span>
</span><span class='line'>          <span class="s1">&#39;countCompleted&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">].</span><span class="n">where</span><span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;isCompleted&quot;</span><span class="p">]).</span><span class="n">length</span><span class="p">})})]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="n">todoAppComponent</span> <span class="o">=</span> <span class="n">registerComponent</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">TodoApp</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s have a look e.g. at <code>headerComponent</code>, which renders the input for creating new tasks, and also adds event handlers to the input. It only receives the <code>appData.value['new-input']</code> value, which defines what should be the value of the input.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// components.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Header</span> <span class="kd">extends</span> <span class="n">_Component</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">_inputChange</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dispatch</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="o">:</span> <span class="s1">&#39;new-input&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">event</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">value</span><span class="p">});</span>
</span><span class='line'>    <span class="n">setState</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">event</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">value</span><span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">render</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>      <span class="n">header</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;header&#39;</span><span class="p">},</span> <span class="p">[</span>
</span><span class='line'>        <span class="n">h1</span><span class="p">({},</span> <span class="s1">&#39;todos&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">input</span><span class="p">({</span>
</span><span class='line'>          <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;new-todo&#39;</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="o">:</span> <span class="s1">&#39;What needs to be done?&#39;</span><span class="p">,</span> <span class="s1">&#39;autofocus&#39;</span><span class="o">:</span> <span class="s1">&#39;autofocus&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;onChange&#39;</span><span class="o">:</span> <span class="n">_inputChange</span><span class="p">,</span> <span class="s1">&#39;onKeyDown&#39;</span><span class="o">:</span> <span class="n">_onKeyDown</span><span class="p">})]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="n">headerComponent</span> <span class="o">=</span> <span class="n">registerComponent</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">Header</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Every single time we enter/remove a character in the input, we fire an event, and its handler <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/dispatcher.dart#L19">calls the dispatch function</a> of Dispatcher. We send the payload to it, which looks like <code>{'action': 'new-input', 'value': input.value}</code>.</p>

<p>There, in Dispatcher, we handle it. For simplicity, I mutate the global state right in Dispatcher, but in a larger application you probably would want to delegate that to a model.</p>

<p>And then, we rerender the app again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="c1">// dispatcher.dart</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">dispatch</span><span class="p">(</span><span class="n">Map</span> <span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">case</span> <span class="s1">&#39;new-input&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="n">appData</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;new-input&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]);</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">rerender</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Summary</h2>

<p>So, that&rsquo;s actually it. Of course there are also other functionality &ndash; editing items, removing items, marking as completed, etc, but it works just in the same way as I just described. For items, there is the <code>Item</code> model &ndash; <a href="https://github.com/astashov/todomvc/blob/master/labs/architecture-examples/react-dart-uniflow/web/dart/models/item.dart">items.dart</a>, which provides API for CRUD operations for items. But all that stuff works in the same way I just described.</p>

<p>That&rsquo;s the whole lifecycle of the application. Very simple, very declarative &ndash; you basically only need to work with the global state, changing it accordingly, and you don&rsquo;t really need to care about the view &ndash; React will do a great job with rendering the app using the global state.</p>

<p>Another cool side-effect of having the global state &ndash; you can always easily reproduce your user&rsquo;s problems &ndash; debugging becomes way easier! If you use something like Airbrake or Rollbar to aggregate exceptions from your users, then you could just attach the global state in JSON to the exception you are about to send to e.g. Rollbar, and then you can easily reproduce the user&rsquo;s problem just by applying that JSON on your machine, so you&rsquo;d get exactly the same state of the app where the user was before the exception happened. Kinda cool, huh? :)</p>

<p>There are a bunch of other cool things (e.g. simple undo &ndash; you can just save the full state of the app (or part of the state) in a vector every time the change happens, and it will be stored efficiently because of the nature of persistent data structures).</p>

<p>I&rsquo;m really excited about this approach so far.</p>

<h2>Isn&rsquo;t that like Rails?</h2>

<p>If you ever worked with Rails, you can actually see a lot of similar things in this approach. In Rails, we pass our request through router, then router figures out (from URLs and GET params) what controller this request should be sent to, controller calls various models, which change the database, and the render the response. In this case,</p>

<ul>
<li>Dispatcher is router</li>
<li>&lsquo;mutators&rsquo; are models</li>
<li>appData is our database</li>
</ul>


<p>In models, we also don&rsquo;t have our internal state, models work with the database, retrieving and saving data into it.
Same as in ActiveRecord :)</p>

<p>And the whole lifecycle of the front-end app like this one and a Rails app looks extremely familiar. :)</p>

<hr />


<p>There are still some things, that could be improved, and some additional persistent data structures, that could be written, like e.g. currently PersistentVector doesn&rsquo;t efficiently handle inserting/removing elements in the middle of a vector. But still, you already can do a lot with the Dart ecosystem and these 2 packages I was talking about &ndash; <code>react</code> and <code>persistent</code>.</p>

<p>So, please try it out, hopefully you&rsquo;ll find it useful :)</p>

<h2>Related links</h2>

<ul>
<li><a href="https://pub.dartlang.org/packages/react">React</a></li>
<li><a href="https://github.com/vacuumlabs/persistent">Persistent</a> &ndash; btw, there is a great explanation why persistent data structures are cool, make sure you&rsquo;ve read that!</li>
<li><a href="https://github.com/astashov/todomvc/tree/master/labs/architecture-examples/react-dart-uniflow/web/dart">Source code</a></li>
<li><a href="http://astashov.s3-us-west-2.amazonaws.com/todomvc/index.html">Demo</a> (Dartium only)</li>
<li><a href="http://www.slideshare.net/AntonAstashov/textik">Slides of my Textik talk</a> &ndash; where I was talking about the Textik&rsquo;s architecture, which is very close to what I described dhere.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/30/perfect-clojurescript-development-environment-with-vim/">Perfect ClojureScript Development Environment With Vim</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-30T17:28:27-07:00" pubdate data-updated="true">Jul 30<sup>th</sup>, 2014</time>
        
           | <a href="/blog/2014/07/30/perfect-clojurescript-development-environment-with-vim/#disqus_thread"
             data-disqus-identifier="http://astashov.github.io/blog/2014/07/30/perfect-clojurescript-development-environment-with-vim/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When I just started to learn ClojureScript, I had hard time trying to find some tutorials which could explain how to set up a nice dev environment for ClojureScript. The good environment is extremely important especially when you just started to play around with the language, it is very useful to get immediate feedback to your changes in the code. But it&rsquo;s also helpful when you already know what you do, and allows you to iterate quickly on your project.</p>

<p>Later, while working on <a href="http://textik.com">Textik</a> (check it out, or check the <a href="http://github.com/astashov/tixi">sources</a>), I was able to build something close enough to the ideal environment, which could allow me to iterate very quickly. To simplify life of ClojureScript beginners, here&rsquo;s a tutorial how to set up that kind of environment.</p>

<p>So, here is a detailed explanation what you need to do from the scratch, or you could just go and clone/fork <a href="http://github.com/astashov/perfection">the skeleton project</a> on Github, if you feel more like tl;dr.</p>

<p>I used Vim for development, but most of this tutorial (except the Vim part) is IDE-agnostic.</p>

<p>To start, let&rsquo;s create a new Clojure project, called &lsquo;perfection&rsquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein new perfection
</span></code></pre></td></tr></table></div></figure>


<p>It will create a skeleton of a Clojure project. Then, open project.clj file, it should look something like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add some lines to turn the project into a ClojureScript project:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adding ClojureScript</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span> <span class="c1">;; &lt;- Sometimes ClojureScript compilation fails because available</span>
</span><span class='line'>                       <span class="c1">;; JVM heap space it too low. This line gives it more space</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- While you can build ClojureScript just by running</span>
</span><span class='line'>                                      <span class="c1">;;    &#39;cljsc&#39;, there is a waaay more convenient way -</span>
</span><span class='line'>                                      <span class="c1">;;    using cljsbuild lein plugin</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">;; This is the list of builds &#39;cljsbuild&#39; will use to compile our ClojureScript</span>
</span><span class='line'>  <span class="c1">;; code into JavaScript. Here we add first build &quot;dev&quot;, it will put resulting main</span>
</span><span class='line'>  <span class="c1">;; entry for JavaScript code to resources/public/perfection.js, and all dependencies</span>
</span><span class='line'>  <span class="c1">;; for it to resources/public/out</span>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, run</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein deps
</span></code></pre></td></tr></table></div></figure>


<p>And <code>lein</code> will install all the new dependencies we just added.</p>

<p>Next, delete the file <code>src/perfection/core.clj</code>, create a new file <code>src/perfection/core.cljs</code>, and put simple &ldquo;Hello World&rdquo; code into it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection.core</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need something to run our compiled JavaScript code. Let&rsquo;s create the index.html file, which will include the generated JavaScript file. Create <code>resources/public/index.html</code> file and add something like this to it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;out/goog/base.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection.core&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s also add some styles, create the <code>resources/public/css/styles.css</code> CSS file with this content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="nb">silver</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try to run compilation, via &lsquo;cljsbuild&rsquo; lein plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein cljsbuild auto dev
</span><span class='line'>Compiling ClojureScript.
</span><span class='line'>Compiling <span class="s2">&quot;resources/public/perfection.js&quot;</span> from <span class="o">[</span><span class="s2">&quot;src&quot;</span><span class="o">]</span>...
</span><span class='line'>Successfully compiled <span class="s2">&quot;resources/public/perfection.js&quot;</span> in 6.829 seconds.
</span></code></pre></td></tr></table></div></figure>


<p>Now we need some server to serve our files. I usually prefer to use Python&rsquo;s SimpleHTTPServer:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python -m SimpleHTTPServer 8000
</span></code></pre></td></tr></table></div></figure>


<p>Next, open a browser and go to <code>http://localhost:8000/resources/public/index.html</code>. Check the console, you should see &ldquo;Hello World!&rdquo; there.</p>

<h2>Figwheel</h2>

<p>Now, you have some running ClojureScript environment, which will automatically and instantly (less than for a second) recompile your files when you change any files in &lsquo;src/perfection&rsquo; directory. Sweet. But we want more.</p>

<p>Meet <a href="https://github.com/bhauman/lein-figwheel">lein-figwheel</a>, amazing lein plugin, which will reload the changed JavaScript files after recompilation in the browser <strong>without</strong> reloading the page! That is so cool. Let&rsquo;s add it to our project:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span> <span class="c1">;; &lt;- Adding Figwheel</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adding also a lein plugin for it</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">;; Figwheel settings. We are going to use &#39;resource/public&#39; directory as our root</span>
</span><span class='line'>  <span class="c1">;; directory for serving the files by the figwheel server, and also we specify</span>
</span><span class='line'>  <span class="c1">;; where our CSS styles live, so Figwheel could reload them without reloading the</span>
</span><span class='line'>  <span class="c1">;; page when we change them as well!</span>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span><span class="p">]</span> <span class="c1">;; &lt;- adding source path where</span>
</span><span class='line'>                                                              <span class="c1">;;    figwheel code will live</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will place the client code for figwheel not in <code>src/perfection</code>, but in a separate dir, because we don&rsquo;t want other builds (like &lsquo;test&rsquo; or &lsquo;release&rsquo;) to include it.</p>

<p>Now, create the file <code>src/figwheel/perfecton_figwheel.cljs</code>, and put this code there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection-figwheel</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">figwheel.client</span> <span class="ss">:as</span> <span class="nv">fw</span> <span class="ss">:include-macros</span> <span class="nv">true</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fw/watch-and-reload</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And require it from <code>resources/public/index.html</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;out/goog/base.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection.core&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- Requiring figwheel --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection_figwheel&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, let&rsquo;s shut down our python server, but run</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein figwheel dev
</span></code></pre></td></tr></table></div></figure>


<p>instead, then open localhost:3449/index.html in the browser, and check the console. It should look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Hello world!
</span><span class='line'>Figwheel: trying to open cljs reload socket
</span><span class='line'>Figwheel: socket connection established
</span></code></pre></td></tr></table></div></figure>


<p>Now go to src/perfection/core.cljs, and change it to something else, e.g. change &ldquo;Hello World!&rdquo; to &ldquo;Hello World 2!&rdquo;. You should see in the console, that we reloaded our files, and the new &ldquo;Hello World 2!&rdquo; output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Figwheel: loading files
</span><span class='line'>Hello world 2!
</span><span class='line'>Figwheel: loaded these files
</span><span class='line'><span class="o">(</span><span class="s2">&quot;/out/perfection/core.js&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Figwheel will also track the changes in CSS and also reload them. Change the background in the CSS file from silver to blue (<code>resources/public/css/style.css</code> file):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and you&rsquo;ll see in the browser console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">Figwheel</span><span class="o">:</span> <span class="nt">loaded</span> <span class="nt">CSS</span> <span class="nt">files</span>
</span><span class='line'><span class="o">(</span><span class="s2">&quot;/css/style.css&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Tests</h2>

<p>I like unit tests. They give me confidence. But it really sucks to manually run them every time, and it especially sucks to run them in Clojure/ClojureScript, because you have to wait for the full JVM start, which takes several seconds. Not really perfect instant experience we are looking for. Thankfully, you can run it once, and then restart the tests on every change of the source or test files, via the same &lsquo;lein clsbuild auto&rsquo; mechanism.</p>

<p>First thing, make sure you have <strong>PhantomJS</strong> installed. If not, install it with HomeBrew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install phantomjs
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&rsquo;s add the &lsquo;test&rsquo; build for <code>cljsbuild</code>, in <code>project.clj</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adding lein plugin for tests</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}</span>
</span><span class='line'>             <span class="c1">;; Adding the new build &#39;test&#39;. Note the :notify-command setting,</span>
</span><span class='line'>             <span class="c1">;; it will run the tests when the files change</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:cljs.test/runner</span> <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;perfection_test.js&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:whitespace</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s add some function to test (<code>src/perfection/core.cljs</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection.core</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="s">&quot;Hello world 2!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Our new function</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add</span> <span class="p">[</span><span class="nv">a</span> <span class="nv">b</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, remove the currently existing <code>test/perfection/core_test.clj</code>, and create a new file <code>test/perfection/core_test.cljs</code>, which will contain our new first failing test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection.core-test</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require-macros</span> <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:refer</span> <span class="p">(</span><span class="nf">is</span> <span class="nv">deftest</span><span class="p">)])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">cemerick.cljs.test</span> <span class="ss">:as</span> <span class="nv">test</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">perfection.core</span> <span class="ss">:as</span> <span class="nv">pn</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">deftest</span> <span class="nv">ex1</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">pn/add</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">4</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s try to run it. It should fail:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein cljsbuild auto <span class="nb">test</span>
</span><span class='line'>Compiling ClojureScript.
</span><span class='line'>Compiling <span class="s2">&quot;perfection_test.js&quot;</span> from <span class="o">[</span><span class="s2">&quot;src/perfection&quot;</span> <span class="s2">&quot;test&quot;</span><span class="o">]</span>...
</span><span class='line'>SyntaxError: Parse error
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Testing perfection.core-test
</span><span class='line'>
</span><span class='line'>FAIL in <span class="o">(</span>perfection.core-test/ex1<span class="o">)</span> <span class="o">(</span>:<span class="o">)</span>
</span><span class='line'>expected: <span class="o">(=</span> <span class="o">(</span>pn/add 1 2<span class="o">)</span> 4<span class="o">)</span>
</span><span class='line'>  actual: <span class="o">(</span>not <span class="o">(=</span> 3 4<span class="o">))</span>
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 1 failures, 0 errors.
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 1 failures, 0 errors.
</span><span class='line'>Successfully compiled <span class="s2">&quot;perfection_test.js&quot;</span> in 4.203 seconds.
</span></code></pre></td></tr></table></div></figure>


<p>Change <code>(is (= (pn/add 1 2) 4))</code> to <code>(is (= (pn/add 1 2) 3))</code>, then save the file, and the test should rerun automatically, and now it should pass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Compiling <span class="s2">&quot;perfection_test.js&quot;</span> from <span class="o">[</span><span class="s2">&quot;src/perfection&quot;</span> <span class="s2">&quot;test&quot;</span><span class="o">]</span>...
</span><span class='line'>SyntaxError: Parse error
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Testing perfection.core-test
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 0 failures, 0 errors.
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 1 assertions.
</span><span class='line'>Testing <span class="nb">complete</span>: 0 failures, 0 errors.
</span><span class='line'>Successfully compiled <span class="s2">&quot;perfection_test.js&quot;</span> in 0.719 seconds.
</span></code></pre></td></tr></table></div></figure>


<p>W00t! Now we have an autorunning test in our app.</p>

<p>Some notes: PhantomJS is pretty old, it lacks a lot of features existing in modern browsers, like <code>Function.bind</code> or <code>requestAnimationFrame</code>. So, for tests you may need shims, you can write them in separate JS files, and then add to <code>:notify-command</code> in <code>project.clj</code> for the &ldquo;test&rdquo; build, e.g. like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span>
</span><span class='line'>                 <span class="ss">:cljs.test/runner</span>
</span><span class='line'>                 <span class="s">&quot;resources/public/js/function-bind-shim.js&quot;</span>
</span><span class='line'>                 <span class="s">&quot;resources/public/js/request-animation-frame-shim.js&quot;</span>
</span><span class='line'>                 <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Integration with Vim</h2>

<p>We already have a lot, but we are not going to stop :). We would also want to quickly search docs for the functions we use from Vim, be able to jump to definitions of the functions, and even execute some code right in the browser&rsquo;s context, right in the context of our running application, straight from Vim. Oh yes, that would be super cool. And that is totally possible, all thanks to famous Vim master Tim Pope and his beautiful &lsquo;vim-fireplace&rsquo; plugin.</p>

<p>So, let&rsquo;s first configure our app so it could accept connections from repl. We need to install brepl to it. As usual, we first need to add some changes to <code>project.clj</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/austin</span> <span class="s">&quot;0.1.4&quot;</span><span class="p">]]</span> <span class="c1">;; &lt;- Adds nice support for ClojureScript REPL.</span>
</span><span class='line'>                                           <span class="c1">;;    Also has Piggieback as a dependency, which</span>
</span><span class='line'>                                           <span class="c1">;;    we need for vim-fireplace</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span> <span class="s">&quot;src/brepl&quot;</span><span class="p">]</span>  <span class="c1">;; &lt;- adding source path</span>
</span><span class='line'>                                                                           <span class="c1">;;    where brepl code</span>
</span><span class='line'>                                                                           <span class="c1">;;    will live</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:cljs.test/runner</span> <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;perfection_test.js&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:whitespace</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Same thing as for figwheel &ndash; we will place the client code for brepl not in <code>src/perfection</code>, but in a separate dir, because we don&rsquo;t want other builds (like &lsquo;test&rsquo; or &lsquo;release&rsquo;) to include it.</p>

<p>Now, create <code>src/brepl/perfection_brepl.cljs</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">perfection-brepl</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.browser.repl</span> <span class="ss">:as</span> <span class="nv">repl</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">repl/connect</span> <span class="s">&quot;http://localhost:9000/repl&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And add its requiring to <code>resources/public/index.html</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;out/goog/base.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection.core&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection_figwheel&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- Requiring brepl --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="nx">goog</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;perfection_brepl&quot;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that, restart <code>lein figwheel dev</code>, then run <code>lein repl</code>.</p>

<p>Now, it&rsquo;s time to install the vim-fireplace plugin for Vim. I use <code>pathogen</code>, so I just simply put the plugin to <code>~/.vim/bundle/vim-fireplace</code>.</p>

<p>Next, restart Vim, open <code>src/perfection/core.cljs</code>, and in Vim run <code>:Piggieback 9000</code>. It will hang for several seconds.</p>

<p>Then reload <code>localhost:3449/index.html</code> in browser.</p>

<p>You may see the exception in the browser console, like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>Uncaught SecurityError: Failed to read the &#39;contentDocument&#39; property from &#39;HTMLIFrameElement&#39;:
</span><span class='line'>Blocked a frame with origin &quot;http://localhost:3449&quot; from accessing a frame with origin
</span><span class='line'>&quot;http://localhost:9000&quot;. Protocols, domains, and ports must match.
</span></code></pre></td></tr></table></div></figure>


<p>but that&rsquo;s totally fine, and will work anyway.</p>

<p>Go back to <code>src/perfection/core.cljs</code> in Vim, and try to run something like <code>:Eval (js/alert 123)</code>. The alert window should appear right in the browser. Cool, huh?</p>

<p>You can do a lot of things with vim-fireplace, just check the docs. It converts Vim to a pretty solid ClojureScript IDE, which now is quite close even to LightTable, but with all that well-known Vim stuff you and me love so much :)</p>

<h2>Release</h2>

<p>Now we have everything we need for comfortable development process, but I highly recommend that you also add another build, which will generate the &ldquo;release&rdquo; version of the app, which will eventually go to production. It is very important to do that right from the beginning, because sometimes there are issues with &ldquo;advanced&rdquo; optimizations of Google Closure (which ClojureScript uses under the hood for compilation). You should really always check that your app works with :advanced optimizations, because debugging may be difficult there.</p>

<p>So, add this to your <code>project.clj</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">perfection</span> <span class="s">&quot;0.1.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;FIXME: write description&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;http://example.com/FIXME&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Eclipse Public License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.eclipse.org/legal/epl-v10.html&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.5.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojurescript</span> <span class="s">&quot;0.0-2277&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:jvm-opts</span> <span class="p">[</span><span class="s">&quot;-Xmx1G&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-cljsbuild</span> <span class="s">&quot;1.0.3&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-figwheel</span> <span class="s">&quot;0.1.3-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/clojurescript.test</span> <span class="s">&quot;0.3.1&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">com.cemerick/austin</span> <span class="s">&quot;0.1.4&quot;</span><span class="p">]]</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:figwheel</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:http-server-root</span> <span class="s">&quot;public&quot;</span>
</span><span class='line'>    <span class="ss">:port</span> <span class="mi">3449</span>
</span><span class='line'>    <span class="ss">:css-dirs</span> <span class="p">[</span><span class="s">&quot;resources/public/css&quot;</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">:cljsbuild</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:builds</span> <span class="p">[{</span><span class="ss">:id</span> <span class="s">&quot;dev&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;src/figwheel&quot;</span> <span class="s">&quot;src/brepl&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:none</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="nv">true</span><span class="p">}}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span> <span class="s">&quot;test&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:notify-command</span> <span class="p">[</span><span class="s">&quot;phantomjs&quot;</span> <span class="ss">:cljs.test/runner</span> <span class="s">&quot;perfection_test.js&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;perfection_test.js&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:whitespace</span><span class="p">}}</span>
</span><span class='line'>             <span class="c1">;; Our release build. The main difference - it uses :optimizations :advanced.</span>
</span><span class='line'>             <span class="c1">;; It also doesn&#39;t include src/figwheel or src/brepl - we don&#39;t need that in production</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;release&quot;</span>
</span><span class='line'>              <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/perfection&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="ss">:compiler</span> <span class="p">{</span>
</span><span class='line'>                <span class="ss">:output-to</span> <span class="s">&quot;resources/public/perfection_prod.js&quot;</span>
</span><span class='line'>                <span class="ss">:output-dir</span> <span class="s">&quot;resources/public/prod-out&quot;</span>
</span><span class='line'>                <span class="ss">:optimizations</span> <span class="ss">:advanced</span>
</span><span class='line'>                <span class="ss">:pretty-print</span> <span class="nv">false</span>
</span><span class='line'>                <span class="ss">:source-map</span> <span class="s">&quot;resources/public/perfection_prod.js.map&quot;</span><span class="p">}}]})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now create <code>resources/public/index_prod.html</code>, it&rsquo;s going to be way shorter than our dev one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Perfection - perfect dev environment for ClojureScript<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;css/style.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;perfection_prod.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein cljsbuild auto release
</span></code></pre></td></tr></table></div></figure>


<p>Now you can open <code>http://localhost:3449/index_prod.html</code>, and make sure the site still works (by checking for &ldquo;Hello World 2!&rdquo; in the console.</p>

<p>BTW, now if you open <code>resources/public/perfection_prod.js</code>, all you will see there is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">;(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hello world 2!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//# sourceMappingURL=perfection_prod.js.map</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s the power of :advanced optimizations. It got rid of everything which is not used (all the ClojureScript libs, Google Closure libs, thousands and thousands of lines of code), and left only what matters.</p>

<h2>Summary</h2>

<p>So, I usually have 4 things running simultaneously:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">lein</span> <span class="nx">repl</span>
</span><span class='line'><span class="nx">lein</span> <span class="nx">figwheel</span> <span class="nx">dev</span>
</span><span class='line'><span class="nx">lein</span> <span class="nx">cljsbuild</span> <span class="nx">auto</span> <span class="nx">test</span>
</span><span class='line'><span class="nx">lein</span> <span class="nx">cljsbuild</span> <span class="nx">auto</span> <span class="nx">release</span>
</span></code></pre></td></tr></table></div></figure>


<p>And whenever I make a change in the source code, I&rsquo;ll get updated version of the app in the browser, without page refresh, the tests will run, and the release will be built. All automagically.</p>

<p>That&rsquo;s what I call &ldquo;the perfect dev environment&rdquo;.</p>

<h2>Tips &amp; Tricks</h2>

<h3>Paredit</h3>

<p>You should use it. Since Clojure is Lisp, and consists of s-expressions, it has a very clear structure. Paredit allows to efficiently edit your code by manipulating s-expressions. This is when all these parentheses, which initially scare Lisp newcomers, will bring power. There is a plugin for Vim, a bit buggy, especially when you copy/paste large structures (especially when they are unbalanced), but it&rsquo;s still worth it.</p>

<h3><code>p</code> and <code>b</code></h3>

<p>I found it very useful for my development process to create the function <code>p</code> and the macro <code>b</code> for debugging.</p>

<ul>
<li><code>p</code> just prints what the value it receives and returns it.</li>
<li><code>b</code> prints what time did the execution of the nested s-expression take, and also returns the value.</li>
</ul>


<p>They look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">p</span> <span class="s">&quot;Prints given arguments, and then returns the last one&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">values</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">.log</span> <span class="nv">js/console</span> <span class="p">(</span><span class="nb">apply pr-str </span><span class="nv">values</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">last </span><span class="nv">values</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">benchmark</span>
</span><span class='line'>  <span class="s">&quot;Prints the execution time for the given function. Accepts optional string, which will</span>
</span><span class='line'><span class="s">   be used as a description&quot;</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">f</span><span class="p">]</span> <span class="p">(</span><span class="nf">benchmark</span> <span class="nv">nil</span> <span class="nv">f</span><span class="p">))</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">msg</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">start</span> <span class="p">(</span><span class="nf">.now</span> <span class="nv">js/Date</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">result</span> <span class="p">(</span><span class="nf">f</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">p</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nb">when </span><span class="nv">msg</span> <span class="p">(</span><span class="nb">str </span><span class="nv">msg</span> <span class="s">&quot;: &quot;</span><span class="p">))</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">.now</span> <span class="nv">js/Date</span><span class="p">)</span> <span class="nv">start</span><span class="p">)</span> <span class="s">&quot;ms&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">result</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">b</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">tixi.utils/benchmark</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="o">~</span><span class="nv">f</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">([</span><span class="nv">msg</span> <span class="nv">f</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">tixi.utils/benchmark</span> <span class="o">~</span><span class="nv">msg</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="o">~</span><span class="nv">f</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then we can use them, like that. Imagine you have a function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">foo</span> <span class="mi">2</span>
</span><span class='line'>      <span class="nv">bar</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="nv">foo</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">foo</span> <span class="nv">bar</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And you are curious about what&rsquo;s the output of <code>(+ 3 foo)</code>. So you can do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">foo</span> <span class="mi">2</span>
</span><span class='line'>      <span class="nv">bar</span> <span class="p">(</span><span class="nf">p</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="nv">foo</span><span class="p">))]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">foo</span> <span class="nv">bar</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it will put &lsquo;5&rsquo; in the browser console. Curious how long it takes to execute it?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">foo</span> <span class="mi">2</span>
</span><span class='line'>      <span class="nv">bar</span> <span class="p">(</span><span class="nf">b</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">3</span> <span class="nv">foo</span><span class="p">))]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">+ </span><span class="nv">foo</span> <span class="nv">bar</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>&lsquo;0ms&rsquo; (obviously :)) will appear in the browser console.</p>

<p>It starts to really shine especially with Paredit, when you can wrap and unwrap parentheses by one keystroke.</p>

<h3>Video</h3>

<p>This is a little screencast I recorded how I develop <a href="http://textik.com">Textik</a>, using the dev environment like that:</p>

<iframe width="835" height="626" src="//www.youtube.com/embed/IWexDxLnnak" frameborder="0" allowfullscreen></iframe>


<h2>Conclusion</h2>

<p>I really think ClojureScript so far is the most interesting and productive way to build complex front-end projects on the web. Especially if you use it with React (and some React wrapper, like <a href="https://github.com/swannodette/om">Om</a>, <a href="https://github.com/holmsand/reagent">Reagent</a> or <a href="https://github.com/levand/quiescent">Quiescent</a>). If you didn&rsquo;t try it yet, you should definitely try, and then hopefully you&rsquo;ll find this article useful :)</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Anton Astashov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'astashovsblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
